import{Map,View,Draw,GeoJSON,getCenter,ImageLayer,Projection,Static,VectorLayer,VectorSource}from"./ol5.min.js";!function(factory){"use strict";!function($,loadImage,Map,View,Draw,GeoJSON,getCenter,ImageLayer,Projection,Static,VectorLayer,VectorSource){var surveyID=0,imageOptions=[],likertOptions={1:["Strongly Disagree","Disagree","Undecided","Agree","Strongly Agree"],2:["Very unsatisfied","Unsatisfied","Neutral","Satisfied","Very satisfied"],3:["Very dissatisfied","Dissatisfied","Neutral","Satisfied","Very satisfied"],4:["Pain","Neutral","No Pain"]},pages={},pageElements={},questionNumbers={},typesToInt={text:1,number:2,multichoice:6,likert:12,heatmap:13},typesToText={1:"text",2:"number",6:"multichoice",12:"likert",13:"heatmap"};$.widget("s3.surveyLayout",{options:{},_create:function(){this.id=surveyID,surveyID+=1,this.eventNamespace=".surveyEditor"},_init:function(){var el=$(this.element),fieldname=el.attr("id");fieldname||(fieldname="surveyEditor-widget-"+this.id),this.fieldname=fieldname,this.recordID=el.data("id"),this.data=null,void 0!==$.searchS3?this.ajaxMethod=$.searchS3:this.ajaxMethod=$.ajaxS3,$.validator.addMethod("lessThanMax",function(value,element){var questionID=element.id.split("-")[1],max=$("#max-"+questionID).val();return""==max?this.optional(element)||!0:this.optional(element)||parseFloat(value)<=max},"needs to be lower than Maximum"),$.validator.addMethod("greaterThanMin",function(value,element){var questionID=element.id.split("-")[1],min=$("#min-"+questionID).val();return""==min?this.optional(element)||!0:this.optional(element)||parseFloat(value)>=min},"needs to be higher than Minimum"),this.refresh()},addQuestion:function(position,page,type,questionID){if("instructions"==type)questionID?this._addQuestion(position,page,type,null,!0):this._addQuestion(position,page,type);else if(questionID)this._addQuestion(position,page,type,questionID,!0);else{var self=this,ajaxURL=S3.Ap.concat("/dc/question/create_json.json"),data=JSON.stringify({type:typesToInt[type],template_id:this.recordID});this.ajaxMethod({url:ajaxURL,type:"POST",data:data,dataType:"json",success:function(data){self._addQuestion(position,page,type,data.question_id)},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},_addQuestion:function(position,page,type,questionID,load){var questionNumber,l10n=this.data.l10n;if(load){for(var i=1,len=Object.keys(questionNumbers).length;i<=len;i++)if(position==questionNumbers[i]){questionNumber=i;break}}else"instructions"==type?this.data.layout[position]={type:"instructions",do:{text:""},say:{text:""}}:(questionNumber=Object.keys(questionNumbers).length+1,questionNumbers[questionNumber]=position,this.data.layout[position]={type:"question",id:questionID},this.data.questions[questionID]={type:typesToInt[type],settings:{},options:[]}),this.saveLayout();var idHtml,dataHtml,editTab,formElements,imageHtml,newChoice,optionsHtml,logicTab,mandatory,question,thisQuestion,translationTab,trash,translationHidden="";l10n||(translationHidden=" hide");var translationTitle='<li class="tab-title l10n'+translationHidden+'"><a href="#translation-'+position+'">Translation</a></li>';if("instructions"==type)idHtml="instruction-"+position,dataHtml="",formElements="#instruction-"+position+" input, #instruction-"+position+" select",trash="#instruction-"+position+" .ucce-delete";else{idHtml="question-"+questionID,dataHtml=' data-number="'+questionNumber+'"',formElements="#question-"+questionID+" input, #question-"+questionID+" select",trash="#question-"+questionID+" .ucce-delete";var checked="";thisQuestion=this.data.questions[questionID],load&&thisQuestion.mandatory&&(checked=" checked"),mandatory='<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="mandatory-'+questionID+'" type="checkbox" '+checked+' class="fleft"><label>Make question mandatory</label></div></div>',"heatmap"!=type&&(optionsHtml=this.pipeOptionsHtml(questionID),imageHtml='<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Add image</label><span id="preview-'+questionID+'" class="preview-empty fleft"></span><label for="image-'+questionID+'" class="button tiny fleft">Upload image</label><input id="image-'+questionID+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"><label class="fleft">or pipe question image:</label><select id="pipe-'+questionID+'" class="fleft">'+optionsHtml+'</select><a id="image-delete-'+questionID+'">Delete</a></div></div>')}switch(question='<div class="thumbnail dl-item" id="'+idHtml+'" data-page="'+page+'"'+dataHtml+'><div class="card-header"><ul class="tabs fleft" data-tab><li class="tab-title active"><a href="#edit-'+position+'">Edit</a></li><li class="tab-title"><a href="#logic-'+position+'">Display logic</a></li> '+translationTitle+'</ul><div class="edit-bar fright"><a><i class="ucce ucce-duplicate"> </i></a><a><i class="ucce ucce-delete"> </i></a><i class="ucce ucce-up"> </i><i class="ucce ucce-down"> </i></div></div><div class="tabs-content">',logicTab='<div class="media content" id="logic-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Only display question if...</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><select id="logic-select-'+position+'"></select></div></div><div class="row" id="logic-response-row-'+position+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-2"><label class="fleft">response is</label></div><div class="columns medium-10" id="logic-response-'+position+'"></div></div></div></div></div>',type){case"instructions":var doText="",doTextL10n="",sayText="",sayTextL10n="";if(load){var thisLayout=this.data.layout[position];doText=thisLayout.do.text,sayText=thisLayout.say.text,l10n&&thisLayout.do.l10n&&(doTextL10n=thisLayout.do.l10n[l10n],sayTextL10n=thisLayout.say.l10n[l10n])}editTab='<div class="media content active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Data collector instructions</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>What instructor should do</label><input id="do-'+position+'" type="text" size=100 placeholder="Type what instructor should do" value="'+doText+'"><label>What instructor should say</label><input id="say-'+position+'" type="text" size=100 placeholder="Type what instructor should say" value="'+sayText+'"></div></div></div>',translationTab='<div class="media content" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Data collector instructions</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>What instructor should do</label><div class="translate-from"></div><input id="do-l10n-'+position+'" type="text" size=100 placeholder="Type translation..." value="'+doTextL10n+'"><label>What instructor should say</label><div class="translate-from"></div><input id="say-l10n-'+position+'" type="text" size=100 placeholder="Type translation..." value="'+sayTextL10n+'"></div></div></div>';break;case"text":var name="",nameL10n="";load&&(name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"")),editTab='<div class="media content active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Text box</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'" type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+"</div>",translationTab='<div class="media content" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Text box</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div></div>';break;case"number":name="",nameL10n="";var min="",max="";if(load){name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"");var isIntInRange=((settings=thisQuestion.settings||{}).requires||{}).isIntInRange;isIntInRange&&(min=isIntInRange.min||"",max=isIntInRange.max||"")}editTab='<div class="media content active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Number question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Restrict input to:</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><form id="answer-'+questionID+'"><label class="fleft">Minimum:</label><input id="min-'+questionID+'" name="min" type="number" value="'+min+'" class="fleft"><label class="fleft">Maximum:</label><input id="max-'+questionID+'" name="max" type="number" value="'+max+'" class="fleft"></form></div></div></div>',translationTab='<div class="media content" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Number question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div></div>';break;case"multichoice":name="",nameL10n="";var choices=newChoice='<div id="choice-row-'+questionID+'-0" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input class="choice-'+questionID+'" type="text" placeholder="Enter an answer choice"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div></div>',choicesL10n="",other="",otherDisabled=" disabled",otherLabel="",otherL10n="",multiple=1,multiChecked="";if(load){name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"");var options=thisQuestion.options||[],optionsL10n=thisQuestion.options_l10n||[];if(lenOptions=options.length){choices="";for(i=0;i<lenOptions;i++)choices+='<div id="choice-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input class="choice-'+questionID+'" type="text" placeholder="Enter an answer choice" value="'+options[i]+'"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div></div>',thisOptionL10n=optionsL10n[i]||"",choicesL10n+='<div id="choice-l10n-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+i+'" class="translate-from">'+options[i]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+thisOptionL10n+'"></div></div></div></div>'}otherL10n="";var otherL10nHide=" hide";(otherLabel=(settings=thisQuestion.settings).other||"")&&(other=" checked",otherDisabled="",otherL10n=settings.otherL10n||"",otherL10nHide=""),choicesL10n+='<div id="other-l10n-row-'+questionID+'" class="row'+otherL10nHide+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="other-l10n-from-'+questionID+'" class="translate-from">'+otherLabel+'</div></div><div class="columns medium-6"><input id="other-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+otherL10n+'"></div></div></div></div>',(multiple=settings.multiple||1)>1&&(multiChecked=" checked")}editTab='<div class="media content active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Multiple choice question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+choices+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="other-'+questionID+'" type="checkbox"'+other+'><label>Add \'other field\'</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label class="fleft">Field label</label><input id="other-label-'+questionID+'" type="text" placeholder="Other (please specify)" value="'+otherLabel+'"'+otherDisabled+'></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="multiple-'+questionID+'" type="checkbox"'+multiChecked+'><label>Allow multiple responses</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label class="fleft">Maximum No. of responses:</label><i class="ucce ucce-minus"> </i> <span id="multiple-count-'+questionID+'">'+multiple+'</span> <i class="ucce ucce-plus"> </i></div></div></div>',translationTab='<div class="media content" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Multiple choice question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row" id="choices-l10n-row-'+questionID+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+choicesL10n+"</div>";break;case"likert":name="",nameL10n="";var settings,displayOptions="",scales=['<option value="1">Agreement (Disagree - Agree)</option>','<option value="2">Satisfaction (Smiley scale)</option>','<option value="3">Satisfaction (Dissatisfied - Satisfied)</option>','<option value="4">Pain scale (3 point)</option>'];if(load)if(name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||""),(settings=thisQuestion.settings)&&settings.hasOwnProperty("scale")){var scale=settings.scale;if(scale){scales[scale-1]=scales[scale-1].replace('">','" selected>'),displayOptions+="<ul>";for(i=0,len=(options=likertOptions[scale]).length;i<len;i++)displayOptions+="<li>"+options[i]+"</li>";displayOptions+="</ul>"}}var scaleOptions=scales.join();editTab='<div class="media content active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Likert-scale</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+imageHtml+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label><select id="scale-'+questionID+'"><option value="">Please choose scale</option>'+scaleOptions+'</select></div></div><div class="row"><div class="columns medium-1"></div><div id="display-'+questionID+'" class="columns medium-11">'+displayOptions+"</div></div></div>",translationTab='<div class="media content" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Likert-scale</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div></div>';break;case"heatmap":name="",nameL10n="";var numClicks=1;choices=newChoice='<div id="choice-row-'+questionID+'-0" class="row"><a class="button tiny secondary choice-define-'+questionID+'">Add region 1</a><input class="choice-'+questionID+'" type="text" placeholder="enter label" disabled><i class="ucce ucce-minus"> </i></div>',choicesL10n="",optionsL10n="";if(load){name=thisQuestion.name,l10n&&(nameL10n=thisQuestion.name_l10n||"");var lenOptions;options=thisQuestion.options||[],optionsL10n=thisQuestion.options_l10n||[];if(lenOptions=options.length){var thisOptionL10n;choices="";for(i=0;i<lenOptions;i++)choices+='<div id="choice-row-'+questionID+"-"+i+'" class="row"><a class="button tiny">Add region '+(i+1)+'</a><input class="choice-'+questionID+'" type="text" placeholder="enter label" value="'+options[i]+'"><i class="ucce ucce-minus"> </i></div>',thisOptionL10n=optionsL10n[i]||"",choicesL10n+='<div id="choice-l10n-row-'+questionID+"-"+i+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+i+'" class="translate-from">'+options[i]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..." value="'+thisOptionL10n+'"></div></div></div></div>';choices+=newChoice.replace("-0","-"+lenOptions).replace("region 1","region "+(lenOptions+1))}numClicks=thisQuestion.settings.numClicks||1}editTab='<div class="media content active" id="edit-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Heatmap</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><input id="name-'+questionID+'"type="text" size=100 placeholder="type question" value="'+name+'"></div></div>'+mandatory+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Image</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label for="image-'+questionID+'" class="button tiny fleft">Upload image</label><input id="image-'+questionID+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6 heatmap" id="map-'+questionID+'"><span id="preview-'+questionID+'" class="preview-empty fleft"></span></div><div class="columns medium-6"><div class="row"><h3>Number of clicks allowed:</h3></div><div class="row" id="clicks-row-'+questionID+'"><i class="ucce ucce-minus"> </i><span> '+numClicks+' </span><i class="ucce ucce-plus"> </i></div><div class="row"><h3>Tap/click regions:</h3></div>'+choices+"</div></div></div></div></div>",translationTab='<div class="media content" id="translation-'+position+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Heatmap</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+questionID+'" class="fright">Q'+questionNumber+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+questionID+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+questionID+'" type="text" size=100 placeholder="type translated question" value="'+nameL10n+'"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row" id="choices-l10n-row-'+questionID+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Regions</label></div></div>'+choicesL10n+"</div>"}question+=editTab,question+=logicTab,question+=translationTab,question+="</div></div>",$("#survey-droppable-"+position).before(question);var newPosition=position+1;$("#survey-droppable-"+position).attr("id","survey-droppable-"+newPosition),pageElements[page]++;var pagePosition=pages[page];$("#section-break-"+pagePosition+" > span").html("PAGE "+page+" ("+pageElements[page]+" ELEMENTS)");var ns=this.eventNamespace,self=this,inputEvents=function(){$(formElements).off("change"+ns).on("change"+ns,function(){var parts=this.id.split("-");if("logic"==parts[0]){var currentPosition=parseInt(parts[parts.length-1]);self.logicSelected($(this),currentPosition)}else if("instructions"==type){currentPosition=parseInt(parts[parts.length-1]);var thisLayout=self.data.layout[currentPosition];thisLayout.do.text=$("#do-"+currentPosition).val(),thisLayout.say.text=$("#say-"+currentPosition).val(),l10n&&(thisLayout.do.hasOwnProperty("10n")||(thisLayout.do.l10n={}),thisLayout.do.l10n[l10n]=$("#do-l10n-"+currentPosition).val(),thisLayout.say.hasOwnProperty("10n")||(thisLayout.say.l10n={}),thisLayout.say.l10n[l10n]=$("#say-l10n-"+currentPosition).val()),self.saveLayout()}else self.saveQuestion(type,questionID)}),"instructions"!=type&&"heatmap"!=type&&$("#pipe-"+questionID).on("change"+ns,function(){var value=$(this).val();if(value){for(var img,i=0,len=imageOptions.length;i<len;i++)if((img=imageOptions[i]).label==value){thisQuestion.settings.pipeImage={id:img.id,region:img.region};break}self.deleteImage(questionID)}else delete thisQuestion.settings.pipeImage;self.saveQuestion(type,questionID)})};if(inputEvents(),"instructions"!=type){if(load){var file=thisQuestion.file;file&&("heatmap"==type?self.heatMap(questionID,file):loadImage(S3.Ap.concat("/default/download/"+file),function(img){var preview=loadImage.scale(img,{canvas:!0,maxHeight:80,maxWidth:80});return $("#preview-"+questionID).removeClass("preview-empty").empty().append(preview),img},{}))}$("#image-delete-"+questionID).on("click"+ns,function(){self.deleteImage(questionID)}),$("#image-"+questionID).fileupload({dataType:"json",dropZone:$("#preview-"+questionID+", #image-"+questionID),maxNumberOfFiles:1,url:S3.Ap.concat("/dc/question/")+questionID+"/image_upload.json",add:function(e,data){if(e.isDefaultPrevented())return!1;(data.autoUpload||!1!==data.autoUpload&&$(this).fileupload("option","autoUpload"))&&data.process().done(function(){if(data.submit(),"heatmap"!=type){var file=data.files[0];loadImage(file,function(img){var preview=loadImage.scale(img,{canvas:!0,maxHeight:80,maxWidth:80});$("#preview-"+questionID).removeClass("preview-empty").empty().append(preview),thisQuestion.settings.hasOwnProperty("pipeImage")&&$("#pipe-"+questionID).val("").trigger("change");var found=!1;for(img in imageOptions)img.id==questionID&&(found=!0);if(!found){var label="Q"+$("#question-"+questionID).data("number")+" "+type;imageOptions.push({label:label,id:questionID})}for(var item,thatQuestionID,questions=self.data.questions,layout=self.data.layout,position=1;position<=Object.keys(layout).length;position++)"question"==(item=layout[position]).type&&13!=questions[thatQuestionID=item.id].type&&$("#pipe-"+thatQuestionID).empty().append(self.pipeOptionsHtml(thatQuestionID));return img},{})}})},done:function(e,data){"heatmap"==type&&self.heatMap(questionID,data.result.file)}})}switch($(trash).on("click"+ns,function(){self.deleteQuestion(type,questionID,this)}),type){case"instructions":case"text":break;case"number":$("#answer-"+questionID).validate({rules:{min:{required:!1,digits:!0,lessThanMax:!0},max:{required:!1,digits:!0,greaterThanMin:!0}},messages:{min:{digits:"Only integers allowed"},max:{digits:"Only integers allowed"}},errorClass:"req",focusCleanup:!0});break;case"multichoice":var multipleCheckbox=$("#multiple-"+questionID),multipleCount=$("#multiple-count-"+questionID);(multichoiceEvents=function(){var deleteOption=$(".choice-"+questionID).next();deleteOption.off("click"+ns).on("click"+ns,function(){if($(".choice-"+questionID).length>1){var currentRow=$(this).closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]);currentRow.remove(),$("#choice-l10n-row-"+questionID+"-"+index).remove();for(var newIndex,optionsCount=$(".choice-"+questionID).length,i=index+1;i<=optionsCount;i++)newIndex=i-1,$("#choice-row-"+questionID+"-"+i).attr("id","choice-row-"+questionID+"-"+newIndex),$("#choice-l10n-row-"+questionID+"-"+i).attr("id","choice-l10n-row-"+questionID+"-"+newIndex),$("#choice-from-"+questionID+"-"+i).attr("id","choice-from-"+questionID+"-"+newIndex);var multiple=parseInt(multipleCount.html());$("#other-"+questionID).prop("checked")&&optionsCount++,multiple>optionsCount&&(multipleCount.html(optionsCount),1==optionsCount&&multipleCheckbox.prop("checked",!1)),self.saveQuestion(type,questionID)}else $(this).prev().val("")}),deleteOption.next().off("click"+ns).on("click"+ns,function(){for(var newIndex,currentRow=$(this).closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]),i=$(".choice-"+questionID).length-1;i>index;i--)newIndex=i+1,$("#choice-row-"+questionID+"-"+i).attr("id","choice-row-"+questionID+"-"+newIndex),$("#choice-l10n-row-"+questionID+"-"+i).attr("id","choice-l10n-row-"+questionID+"-"+newIndex),$("#choice-from-"+questionID+"-"+i).attr("id","choice-from-"+questionID+"-"+newIndex);newIndex=index+1,currentRow.after(newChoice.replace("-0","-"+newIndex));var choiceL10nRow='<div id="choice-l10n-row-'+questionID+"-"+newIndex+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+newIndex+'" class="translate-from"></div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..."></div></div></div></div>';$("#choice-l10n-row-"+questionID+"-"+index).after(choiceL10nRow),inputEvents(),multichoiceEvents()}),$("#other-"+questionID).on("change"+ns,function(){if($(this).prop("checked"))$("#other-label-"+questionID).prop("disabled",!1),$("#other-l10n-row-"+questionID).removeClass("hide").show();else{$("#other-label-"+questionID).prop("disabled",!0),$("#other-l10n-row-"+questionID).hide();var multiple=parseInt(multipleCount.html()),optionsCount=$(".choice-"+questionID).length;multiple>optionsCount&&(multipleCount.html(optionsCount),1==optionsCount&&multipleCheckbox.prop("checked",!1))}}),multipleCheckbox.on("change"+ns,function(){if(multipleCheckbox.prop("checked")){parseInt(multipleCount.html());var optionsCount=$(".choice-"+questionID).length;$("#other-"+questionID).prop("checked")&&optionsCount++,optionsCount>1?multipleCount.html(2):multipleCheckbox.prop("checked",!1)}else multipleCount.html(1);self.saveQuestion(type,questionID)}),multipleCount.prev().on("click"+ns,function(){if(multipleCheckbox.prop("checked")){var multiple=parseInt(multipleCount.html());multiple>2?(multipleCount.html(multiple-1),self.saveQuestion(type,questionID)):2==multiple&&(multipleCount.html(1),multipleCheckbox.prop("checked",!1),self.saveQuestion(type,questionID))}}),multipleCount.next().on("click"+ns,function(){if(multipleCheckbox.prop("checked")){var multiple=parseInt(multipleCount.html()),optionsCount=$(".choice-"+questionID).length;$("#other-"+questionID).prop("checked")&&optionsCount++,multiple<optionsCount&&(multipleCount.html(multiple+1),self.saveQuestion(type,questionID))}})})();break;case"likert":$("#scale-"+questionID).on("change"+ns,function(){var scale=$(this).val();if(scale){for(var options=likertOptions[scale],scaleOptions="",i=0,len=options.length;i<len;i++)scaleOptions+="<li>"+options[i]+"</li>";var scaleDisplay="<ul>"+scaleOptions+"</ul>";$("#display-"+questionID).empty().append(scaleDisplay)}else $("#display-"+questionID).empty()});break;case"heatmap":var multichoiceEvents;(multichoiceEvents=function(){$(".choice-"+questionID).next().off("click"+ns).on("click"+ns,function(){if($(".choice-"+questionID).length>1){var currentRow=$(this).closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]);currentRow.remove(),$("#choice-l10n-row-"+questionID+"-"+index).remove();for(var newIndex,optionsCount=$(".choice-"+questionID).length,i=index+1;i<=optionsCount;i++)newIndex=i-1,$("#choice-row-"+questionID+"-"+i).attr("id","choice-row-"+questionID+"-"+newIndex),$("#choice-row-"+questionID+"-"+newIndex+" > .button").html("Add region "+(newIndex+1)),$("#choice-l10n-row-"+questionID+"-"+i).attr("id","choice-l10n-row-"+questionID+"-"+newIndex),$("#choice-from-"+questionID+"-"+i).attr("id","choice-from-"+questionID+"-"+newIndex);self.saveQuestion(type,questionID)}else{var input=$(this).prev();input.val("").prop("disabled",!0),input.prev().addClass("secondary")}}),$(".choice-define-"+questionID).off("click"+ns).on("click"+ns,function(){var $this=$(this),currentRow=$this.closest(".row"),index=parseInt(currentRow.attr("id").split("-")[3]);self.data.questions[questionID].settings.regions;if($this.hasClass("secondary")){var newIndex=index+1;currentRow.after(newChoice.replace("-0","-"+newIndex)),$("#choice-row-"+questionID+"-"+newIndex+" > .button").html("Add region "+(newIndex+1));var choiceL10nRow='<div id="choice-l10n-row-'+questionID+"-"+index+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+questionID+"-"+index+'" class="translate-from"></div></div><div class="columns medium-6"><input class="choice-l10n-'+questionID+'" type="text" placeholder="Type translation..."></div></div></div></div>';0==index?$("#choices-l10n-row-"+questionID).after(choiceL10nRow):$("#choice-l10n-row-"+questionID+"-"+(index-1)).after(choiceL10nRow),inputEvents(),multichoiceEvents()}$this.removeClass("secondary"),$this.next().prop("disabled",!1)})})();var minusClick=$("#clicks-row-"+questionID).children().first();minusClick.off("click"+ns).on("click"+ns,function(){var $this=$(this),value=parseInt($this.next().html());value>1&&(value--,self.data.questions[questionID].settings.numClicks=value,self.saveQuestion(type,questionID),$this.next().html(" "+value+" "))}),minusClick.next().next().off("click"+ns).on("click"+ns,function(){var $prev=$(this).prev(),value=parseInt($prev.html());value++,self.data.questions[questionID].settings.numClicks=value,self.saveQuestion(type,questionID),$prev.html(" "+value+" ")})}"instructions"==type?$("#instruction-"+position).foundation("tab","reflow"):$("#question-"+questionID).foundation("tab","reflow")},deleteQuestion:function(type,questionID,deleteBtn){var currentPage,currentPosition,questionNumber;"instructions"==type?(currentPosition=parseInt($(deleteBtn).closest(".dl-item").attr("id").split("-")[1]),currentPage=$("#instruction-"+currentPosition).data("page")):(questionNumber=$("#question-"+questionID).data("number"),currentPosition=questionNumbers[questionNumber],currentPage=$("#question-"+questionID).data("page")),pageElements[currentPage]--,$("#section-break-"+pages[currentPage]+" > span").html("PAGE "+currentPage+" ("+pageElements[currentPage]+" ELEMENTS)");for(var i=currentPage+1,len=Object.keys(pages).length;i<=len;i++)pages[i]--;var item,$item,oldPosition,thisQuestionID,newQuestionNumber,oldHref,newHref,oldQuestionNumber=questionNumber,layout=this.data.layout,layoutLength=Object.keys(layout).length;for(i=currentPosition;i<layoutLength;i++)item=layout[oldPosition=i+1],layout[i]=item,"break"==item.type?$("#section-break-"+oldPosition).attr("id","section-break-"+i):("question"==item.type?(thisQuestionID=item.id,oldQuestionNumber=($item=$("#question-"+thisQuestionID)).data("number"),"instructions"==type?questionNumbers[oldQuestionNumber]=i:(newQuestionNumber=oldQuestionNumber-1,$item.data("number",newQuestionNumber),$("#qlabel-"+thisQuestionID).html("Q"+newQuestionNumber),$("#qlabel-l10n-"+thisQuestionID).html("Q"+newQuestionNumber),questionNumbers[newQuestionNumber]=i)):($("#instruction-"+oldPosition).attr("id","instruction-"+i),$item=$("#instruction-"+i),$("#do-"+oldPosition).attr("id","do-"+i),$("#say-"+oldPosition).attr("id","say-"+i),$("#do-l10n-"+oldPosition).attr("id","do-l10n-"+i),$("#say-l10n-"+oldPosition).attr("id","say-l10n-"+i)),$("#edit-"+oldPosition).attr("id","edit-"+i),$("#logic-"+oldPosition).attr("id","logic-"+i),$("#translation-"+oldPosition).attr("id","translation-"+i),$item.find("li.tab-title > a").each(function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+i)}));if(delete layout[layoutLength],"instructions"!=type&&delete questionNumbers[oldQuestionNumber],this.saveLayout(),"instructions"==type?$("#instruction-"+currentPosition).remove():$("#question-"+questionID).remove(),$("#survey-droppable-"+(layoutLength+1)).attr("id","survey-droppable-"+layoutLength),"instructions"!=type){var ajaxURL=S3.Ap.concat("/dc/question/")+questionID+"/delete.json";this.ajaxMethod({url:ajaxURL,type:"POST",dataType:"json",success:function(){},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},heatMap:function(questionID,file){var url=S3.Ap.concat("/default/download/"+file);$("<img>").attr("src",url).load(function(){var width=this.width,height=this.height;$("#map-"+questionID).empty();var extent=[0,0,width,height],projection=new Projection({code:"preview-image",units:"pixels",extent:extent}),raster=new ImageLayer({source:new Static({url:url,projection:projection,imageExtent:extent})}),source=new VectorSource({wrapX:!1}),vector=new VectorLayer({source:source}),map=new Map({controls:[],interactions:[],layers:[raster,vector],target:"map-"+questionID,view:new View({projection:projection,center:getCenter(extent),zoom:1,maxZoom:1})}),draw=new Draw({source:source,type:"Polygon"});map.addInteraction(draw)})},pipeOptionsHtml:function(questionID){var img,pipeImage,thisQuestion=this.data.questions[questionID],optionsHtml='<option value="">select question</option>';thisQuestion&&thisQuestion.settings&&thisQuestion.settings.pipeImage&&(pipeImage=thisQuestion.settings.pipeImage);for(var i=0,len=imageOptions.length;i<len;i++)(img=imageOptions[i]).id!=questionID&&(pipeImage&&pipeImage.id==img.id&&pipeImage.region==img.region?optionsHtml+="<option selected>"+img.label+"</option>":optionsHtml+="<option>"+img.label+"</option>");return optionsHtml},logicOptionsHtml:function(questionID,currentPosition){var qtype,displayLogicID,thisQuestion,thisQuestionID,str,optionsHtml='<option value="">select question</option>',questions=this.data.questions,layout=this.data.layout,displayLogic=layout[currentPosition].displayLogic;displayLogic&&(displayLogicID=displayLogic.id);for(var i=1,len=Object.keys(questionNumbers).length;i<=len;i++)(thisQuestionID=layout[questionNumbers[i]].id)==questionID||(thisQuestion=questions[thisQuestionID],"number"!=(qtype=typesToText[thisQuestion.type])&&"multichoice"!=qtype&&"likert"!=qtype&&"heatmap"!=qtype||(optionsHtml+='<option value="'+thisQuestionID+'"'+(thisQuestionID==displayLogicID?" selected":"")+">"+("Q"+i+": "+((str=thisQuestion.name||"").length>53?str.substring(0,50)+"...":str))+"</option>"));return optionsHtml},logicSubOptions:function(currentPosition,logicQuestionID){var label,ns=this.eventNamespace,self=this,displayLogic=this.data.layout[currentPosition].displayLogic,logicQuestion=this.data.questions[logicQuestionID],type=typesToText[logicQuestion.type];if("number"==type){var displayLogicGreaterThan,displayLogicLessThan,displayLogicEquals="",value="";displayLogic&&(displayLogicEquals=displayLogic.eq||"",displayLogicGreaterThan=displayLogic.gt,displayLogicLessThan=displayLogic.lt,displayLogicEquals?value=displayLogicEquals:displayLogicLessThan?value=displayLogicLessThan:displayLogicGreaterThan&&(value=displayLogicGreaterThan));var hide,row1='<select id="logic-operator-1-'+currentPosition+'">';row1+=!displayLogic||displayLogicEquals?'<option value="eq" selected>equal to ( = )</option>':'<option value="eq">equal to ( = )</option>',displayLogicLessThan?(row1+='<option value="lt" selected>less than ( &lt; )</option>',row1+='<option value="gt">more than ( &gt; )</option>'):(row1+='<option value="lt">less than ( &lt; )</option>',row1+=displayLogicGreaterThan?'<option value="gt" selected>more than ( &gt; )</option>':'<option value="gt">more than ( &gt; )</option>'),row1+='</select><input id="logic-term-1-'+currentPosition+'" type="number" placeholder="type number" value="'+value+'">',$("#logic-response-"+currentPosition).html(row1),displayLogicEquals||!displayLogicLessThan&&!displayLogicGreaterThan?(value="",hide=" hide"):(hide="",value=displayLogicLessThan&&displayLogicGreaterThan?displayLogicGreaterThan:"");var row2='<div class="row'+hide+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-2"><label class="fleft">AND</label></div><div class="columns medium-10"><select id="logic-operator-2-'+currentPosition+'">'+(!displayLogicLessThan&&displayLogicGreaterThan?'<option value="lt" selected>less than ( &lt; )</option><option value="gt">more than ( &gt; )</option>':'<option value="lt">less than ( &lt; )</option><option value="gt" selected>more than ( &gt; )</option>')+'</select><input id="logic-term-2-'+currentPosition+'" type="number" placeholder="type number" value="'+value+'"></div></div></div></div>',logicResponseRow=$("#logic-response-row-"+currentPosition);logicResponseRow.after(row2);var operator,logicOperator1=$("#logic-operator-1-"+currentPosition),logicOperator2=$("#logic-operator-2-"+currentPosition),logicTerm1=$("#logic-term-1-"+currentPosition),logicTerm2=$("#logic-term-2-"+currentPosition);return logicOperator1.on("change"+ns,function(){operator=$(this).val(),value=logicTerm1.val(),displayLogic={id:logicQuestionID},"eq"==operator?(logicResponseRow.next().hide(),value&&(displayLogic.eq=value)):"gt"==operator?(logicResponseRow.next().removeClass("hide").show(),logicOperator2.val("lt"),value&&(displayLogic.gt=value),(value=logicTerm2.val())&&(displayLogic.lt=value)):"lt"==operator&&(logicResponseRow.next().removeClass("hide").show(),logicOperator2.val("gt"),value&&(displayLogic.lt=value),(value=logicTerm2.val())&&(displayLogic.gt=value)),self.data.layout[currentPosition].displayLogic=displayLogic,self.saveLayout()}),logicOperator2.on("change"+ns,function(){operator=$(this).val(),value=logicTerm2.val(),displayLogic={id:logicQuestionID},"gt"==operator?(logicOperator1.val("lt"),value&&(displayLogic.gt=value),(value=logicTerm1.val())&&(displayLogic.lt=value)):"lt"==operator&&(logicOperator1.val("gt"),value&&(displayLogic.lt=value),(value=logicTerm1.val())&&(displayLogic.gt=value)),self.data.layout[currentPosition].displayLogic=displayLogic,self.saveLayout()}),logicTerm1.on("change"+ns,function(){(value=$(this).val())?(displayLogic={id:logicQuestionID},"eq"==(operator=logicOperator1.val())?displayLogic.eq=value:("gt"==operator?displayLogic.gt=value:displayLogic.lt=value,(value=logicTerm2.val())&&("gt"==(operator=logicOperator2.val())?displayLogic.gt=value:displayLogic.lt=value)),self.data.layout[currentPosition].displayLogic=displayLogic):(value=logicTerm2.val())?(displayLogic={id:logicQuestionID},"gt"==(operator=logicOperator1.val())?displayLogic.gt=value:displayLogic.lt=value,self.data.layout[currentPosition].displayLogic=displayLogic):delete self.data.layout[currentPosition].displayLogic,self.saveLayout()}),void logicTerm2.on("change"+ns,function(){(value=$(this).val())?(displayLogic={id:logicQuestionID},"gt"==(operator=logicOperator2.val())?displayLogic.gt=value:displayLogic.lt=value,(value=logicTerm1.val())&&("gt"==(operator=logicOperator1.val())?displayLogic.gt=value:displayLogic.lt=value),self.data.layout[currentPosition].displayLogic=displayLogic):(value=logicTerm1.val())?(displayLogic={id:logicQuestionID},"eq"==(operator=logicOperator1.val())?displayLogic.eq=value:"gt"==operator?displayLogic.gt=value:displayLogic.lt=value,self.data.layout[currentPosition].displayLogic=displayLogic):delete self.data.layout[currentPosition].displayLogic,self.saveLayout()})}label="heatmap"==type?"region":"option";var displayLogicOption,opt,options=logicQuestion.options,subOptionSelect='<select id="sub-logic-select-'+currentPosition+'"><option value="">select '+label+"</option>";displayLogic&&(displayLogicOption=displayLogic.eq);for(var i=0,len=options.length;i<len;i++)subOptionSelect+='<option value="'+(opt=options[i])+'"'+(opt==displayLogicOption?" selected":"")+">"+opt+"</option>";if("multichoice"==type){var otherLabel=logicQuestion.settings.other;otherLabel&&(subOptionSelect+='<option value="_other"'+("_other"==displayLogicOption?" selected":"")+">"+otherLabel+"</option>")}subOptionSelect+="</select>",$("#logic-response-"+currentPosition).html(subOptionSelect),$("#sub-logic-select-"+currentPosition).on("change"+ns,function(){self.data.layout[currentPosition].displayLogic={id:logicQuestionID,eq:$(this).val()},self.saveLayout()})},logicSelected:function(logicSelect,currentPosition){var value=logicSelect.val();$("#logic-response-"+currentPosition).empty(),$("#logic-response-row-"+currentPosition).next().remove(),value?this.logicSubOptions(currentPosition,value):(delete this.data.layout[currentPosition].displayLogic,this.saveLayout())},deleteImage:function(questionID){var self=this,preview=$("#preview-"+questionID);if(!preview.hasClass("preview-empty")){var ajaxURL=S3.Ap.concat("/dc/question/")+questionID+"/image_delete.json";this.ajaxMethod({url:ajaxURL,type:"POST",dataType:"json",success:function(){preview.empty().addClass("preview-empty");var img,oldOptions=imageOptions;imageOptions=[];for(var i=0,len=oldOptions.length;i<len;i++)(img=oldOptions[i]).id!=questionID&&imageOptions.push(img);for(var item,thisQuestionID,questions=self.data.questions,layout=self.data.layout,position=1;position<=Object.keys(layout).length;position++)"question"==(item=layout[position]).type&&13!=questions[thisQuestionID=item.id].type&&$("#pipe-"+thisQuestionID).empty().append(self.pipeOptionsHtml(thisQuestionID))},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},addSectionBreak:function(position,page,load){pages[++page]=position,pageElements[page]=0;var sectionBreak='<div class="row"><div class="section-break medium-11 columns" id="section-break-'+position+'" data-page="'+page+'"><span>PAGE '+page+' (0 ELEMENTS)</span></div><div class="medium-1 columns">'+(position?'<i class="ucce ucce-delete-page"> </i>':"")+'<i class="ucce ucce-down-alt"> </i></div></div>';if(position){$("#survey-droppable-"+position).before(sectionBreak);var newPosition=position+1;$("#survey-droppable-"+position).data("page",page).attr("id","survey-droppable-"+newPosition),load||(this.data.layout[position]={type:"break"},this.saveLayout());var self=this,ns=this.eventNamespace;$("#section-break-"+position).next().children(".ucce-delete-page").on("click"+ns,function(){var currentPosition=parseInt($(this).parent().prev().attr("id").split("-")[2]);self.deleteSectionBreak(currentPosition)})}else $(this.element).parent().append(sectionBreak)},deleteSectionBreak:function(currentPosition){var currentPage=$("#section-break-"+currentPosition).data("page"),currentPageElements=pageElements[currentPage];if(currentPageElements){var previousPage=currentPage-1;pageElements[previousPage]+=currentPageElements;var previousPagePosition=pages[previousPage];$("#section-break-"+previousPagePosition+" > span").html("PAGE "+previousPage+" ("+pageElements[previousPage]+" ELEMENTS)")}for(var pagesLength=Object.keys(pages).length,i=currentPage;i<pagesLength;i++)pages[i]=pages[i+1]-1,pageElements[i]=pageElements[i+1];delete pages[pagesLength],delete pageElements[pagesLength];var layout=this.data.layout,layoutLength=Object.keys(layout).length;if(currentPosition!=layoutLength){var item,thisPage,oldPosition,oldHref,newHref,questionNumber,$item;for(i=currentPosition;i<layoutLength;i++)item=layout[oldPosition=i+1],layout[i]=item,"break"==item.type?(thisPage=$("#section-break-"+oldPosition).data("page")-1,$("#section-break-"+oldPosition).data("page",thisPage),$("#section-break-"+oldPosition+" > span").html("PAGE "+thisPage+" ("+pageElements[thisPage]+" ELEMENTS)"),$("#section-break-"+oldPosition).attr("id","section-break-"+i)):("question"==item.type?(questionNumber=($item=$("#question-"+item.id)).data("number"),questionNumbers[questionNumber]=i):($("#instruction-"+oldPosition).attr("id","instruction-"+i),$item=$("#instruction-"+i),$("#do-"+oldPosition).attr("id","do-"+i),$("#say-"+oldPosition).attr("id","say-"+i),$("#do-l10n-"+oldPosition).attr("id","do-"+i),$("#say-l10n-"+oldPosition).attr("id","say-"+i)),$("#edit-"+oldPosition).attr("id","edit-"+i),$("#logic-"+oldPosition).attr("id","logic-"+i),$("#translation-"+oldPosition).attr("id","translation-"+i),$item.find("li.tab-title > a").each(function(){var $this=$(this);oldHref=$this.attr("href"),newHref=(newHref=oldHref.split("-")[0]).substring(1,newHref.length),$this.attr("href","#"+newHref+"-"+i)}))}delete layout[layoutLength],this.saveLayout(),$("#section-break-"+currentPosition).parent().remove(),$("#survey-droppable-"+(layoutLength+1)).data("page",pagesLength-1).attr("id","survey-droppable-"+layoutLength)},droppable:function(position,page){var self=this,droppable='<div class="survey-droppable" id="survey-droppable-'+position+'" data-page="'+page+'"><span>Drag and drop questions here</span></div>';$(this.element).parent().append(droppable),$("#survey-droppable-"+position).droppable({drop:function(event,ui){var type=ui.draggable[0].id,currentPosition=parseInt(this.id.split("-")[2]),currentPage=$(this).data("page");"break"==type?self.addSectionBreak(currentPosition,currentPage):self.addQuestion(currentPosition,currentPage,type)}})},_destroy:function(){$.Widget.prototype.destroy.call(this)},loadSurvey:function(){var layout=this.data.layout;if(layout){for(var item,questionID,thisQuestion,base_label,label,page=1,questionNumber=0,questions=this.data.questions,layoutLength=Object.keys(layout).length,position=1;position<=layoutLength;position++)if("break"==(item=layout[position]).type);else if("instructions"==item.type);else if(questionNumbers[++questionNumber]=position,(thisQuestion=questions[questionID=item.id]).file)if(13==thisQuestion.type){var regions=thisQuestion.settings.regions;if(regions){base_label="Q"+questionNumber+" Heatmap; ";for(var i=0,len=regions.length;i<len;i++)label=base_label+"'"+regions[i].label+"'",imageOptions.push({label:label,id:questionID,region:i})}}else label="Q"+questionNumber+" "+typesToText[thisQuestion.type],imageOptions.push({label:label,id:questionID});for(position=1;position<=layoutLength;position++)"break"==(item=layout[position]).type?(this.addSectionBreak(position,page,!0),page++):"instructions"==item.type?this.addQuestion(position,page,"instructions",!0):(questionID=item.id,this.addQuestion(position,page,typesToText[questions[questionID].type],questionID))}},refresh:function(){this._unbindEvents(),this._deserialize(),this.addSectionBreak(0,0),this.droppable(1,1),this.loadSurvey(),this._bindEvents()},saveQuestion:function(type,questionID){var name=$("#name-"+questionID).val();if(name){var ajaxURL=S3.Ap.concat("/dc/question/")+questionID+"/update_json.json",mandatory=$("#mandatory-"+questionID).prop("checked"),data={name:name,mandatory:mandatory},l10n=this.data.l10n,settings={},thisQuestion=this.data.questions[questionID];if(thisQuestion.name=name,thisQuestion.mandatory=mandatory,l10n){var name_l10n=$("#name-l10n-"+questionID).val();name_l10n&&(data.name_l10n=name_l10n,thisQuestion.name_l10n=name_l10n)}var pipeImage=thisQuestion.settings.pipeImage;switch(pipeImage&&(settings.pipeImage=pipeImage),type){case"text":break;case"number":var min,max;$("#min-"+questionID).hasClass("req")?min=null:(min=$("#min-"+questionID).val())&&(min=parseInt(min)),$("#max-"+questionID).hasClass("req")?max=null:(max=$("#max-"+questionID).val())&&(max=parseInt(max)),settings.requires={isIntInRange:{min:min,max:max}};break;case"multichoice":var options=[];if($(".choice-"+questionID).each(function(){options.push($(this).val())}),data.options=options,thisQuestion.options=options,l10n){var options_l10n=[];$(".choice-l10n-"+questionID).each(function(){options_l10n.push($(this).val())}),data.options_l10n=options_l10n}$("#other-"+questionID).prop("checked")?(settings.other=$("#other-label-"+questionID).val(),l10n&&(settings.otherL10n=$("#other-l10n-"+questionID).val())):(settings.other=null,l10n&&(settings.otherL10n=null)),$("#multiple-"+questionID).prop("checked")?settings.multiple=parseInt($("#multiple-count-"+questionID).html()):settings.multiple=1;break;case"likert":var scale=$("#scale-"+questionID).val();scale?(options=likertOptions[scale],settings.scale=scale):(options=[],settings.scale=null),data.options=options,thisQuestion.options=options;break;case"heatmap":options=[];if($(".choice-"+questionID).each(function(){options.push($(this).val())}),options.pop(),data.options=options,thisQuestion.options=options,l10n){options_l10n=[];$(".choice-l10n-"+questionID).each(function(){options_l10n.push($(this).val())}),data.options_l10n=options_l10n}var numClicks=thisQuestion.settings.numClicks;numClicks&&(settings.numClicks=numClicks)}data.settings=settings,thisQuestion.settings=settings,this.ajaxMethod({url:ajaxURL,type:"POST",data:JSON.stringify(data),dataType:"json",success:function(){},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})}},saveLayout:function(){var ajaxURL=S3.Ap.concat("/dc/template/")+this.recordID+"/update_json.json";this.ajaxMethod({url:ajaxURL,type:"POST",data:JSON.stringify({layout:this.data.layout}),dataType:"json",success:function(){},error:function(jqXHR,textStatus,errorThrown){var msg;msg="UNAUTHORIZED"==errorThrown?i18n.gis_requires_login:jqXHR.responseText,console.log(msg)}})},_deserialize:function(){var value=$(this.element).val()||"{}";return this.data=JSON.parse(value),this.data},_bindEvents:function(){var self=this,ns=this.eventNamespace,surveyName=$("#survey-name");$(document).foundation({tab:{callback:function(tab){var tabText=tab.text();if("Display logic"==tabText){var currentPosition=tab.children().first().attr("href").split("-")[1],logicSelect=$("#logic-select-"+currentPosition);if("instruction"==(parts=tab.closest(".dl-item").attr("id").split("-"))[0])logicSelect.html(self.logicOptionsHtml(null,currentPosition));else{var questionID=parts[1];logicSelect.html(self.logicOptionsHtml(questionID,currentPosition))}self.logicSelected(logicSelect,currentPosition)}else if("Translation"==tabText){var parts;currentPosition=tab.children().first().attr("href").split("-")[1];if("instruction"==(parts=tab.closest(".dl-item").attr("id").split("-"))[0])$("#do-l10n-"+currentPosition).prev().html($("#do-"+currentPosition).val()),$("#say-l10n-"+currentPosition).prev().html($("#say-"+currentPosition).val());else{questionID=parts[1];var thisQuestion=self.data.questions[questionID];switch($("#name-l10n-from-"+questionID).html($("#name-"+questionID).val()),typesToText[thisQuestion.type]){case"text":case"number":break;case"multichoice":$(".choice-"+questionID).each(function(index){$("#choice-from-"+questionID+"-"+index).html($(this).val())}),$("#other-l10n-from-"+questionID).html($("#other-label-"+questionID).val());break;case"likert":break;case"heatmap":$(".choice-"+questionID).each(function(index){$("#choice-from-"+questionID+"-"+index).html($(this).val())})}}}}}}),surveyName.on("change"+ns,function(){var name=surveyName.val(),recordID=surveyName.data("id");self.ajaxMethod({url:S3.Ap.concat("/dc/target/")+recordID+"/name.json",type:"POST",data:JSON.stringify({name:name}),dataType:"json",success:function(){},error:function(request,status,error){var msg;msg="UNAUTHORIZED"==error?i18n.gis_requires_login:request.responseText,console.log(msg)}})}),$("#survey-l10n").on("change"+ns,function(){var l10n=$(this).val(),recordID=surveyName.data("id");self.ajaxMethod({url:S3.Ap.concat("/dc/target/")+recordID+"/l10n.json",type:"POST",data:JSON.stringify({l10n:l10n}),dataType:"json",success:function(){self.data.l10n=l10n,l10n?($("li.l10n").removeClass("hide").show(),$(document).foundation("tab","reflow")):$("li.l10n").hide()},error:function(request,status,error){var msg;msg="UNAUTHORIZED"==error?i18n.gis_requires_login:request.responseText,console.log(msg)}})}),$(".draggable").draggable({revert:!0,revertDuration:250})},_unbindEvents:function(){var ns=this.eventNamespace;$("#survey-name").unbind(ns),$("#survey-l10n").unbind(ns);var draggable_el=$(".draggable");return null!=draggable_el.draggable("instance")&&draggable_el.draggable("destroy"),!0}})}(window.jQuery,window.loadImage,Map,View,Draw,0,getCenter,ImageLayer,Projection,Static,VectorLayer,VectorSource)}();