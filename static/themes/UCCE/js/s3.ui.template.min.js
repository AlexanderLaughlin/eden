var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var n=0;return function(){return n<a.length?{done:!1,value:a[n++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,n,k){a!=Array.prototype&&a!=Object.prototype&&(a[n]=k.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(a,n){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:n})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(k){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(k||"")+"_"+n++,k)}var n=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,n){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var k=0,p={next:function(){if(k<a.length){var u=k++;return{value:n(u,a[u]),done:!1}}p.next=function(){return{done:!0,value:void 0}};return p.next()}};p[Symbol.iterator]=function(){return p};return p};
$jscomp.polyfill=function(a,n,k,p){if(n){k=$jscomp.global;a=a.split(".");for(p=0;p<a.length-1;p++){var u=a[p];u in k||(k[u]={});k=k[u]}a=a[a.length-1];p=k[a];n=n(p);n!=p&&null!=n&&$jscomp.defineProperty(k,a,{configurable:!0,writable:!0,value:n})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.findInternal=function(a,n,k){a instanceof String&&(a=String(a));for(var p=a.length,u=0;u<p;u++){var z=a[u];if(n.call(k,z,u,a))return{i:u,v:z}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,k){return $jscomp.findInternal(this,a,k).v}},"es6","es3");
(function(a){a(window.jQuery,window.loadImage)})(function(a,n){var k=0,p=[],u={1:["Strongly Disagree","Disagree","Undecided","Agree","Strongly Agree"],2:["Very unsatisfied","Unsatisfied","Neutral","Satisfied","Very satisfied"],3:["Very dissatisfied","Dissatisfied","Neutral","Satisfied","Very satisfied"],4:["Pain","Neutral","No Pain"]},z={},A={},C={},K={text:1,number:2,multichoice:6,likert:12,heatmap:13},J={1:"text",2:"number",6:"multichoice",12:"likert",13:"heatmap"};a.widget("s3.surveyLayout",{options:{},
_create:function(){this.id=k;k+=1;this.eventNamespace=".surveyEditor"},_init:function(){var e=a(this.element),c=e.attr("id");c||(c="surveyEditor-widget-"+this.id);this.fieldname=c;this.recordID=e.data("id");this.data=null;this.ajaxMethod=void 0!==a.searchS3?a.searchS3:a.ajaxS3;a.validator.addMethod("lessThanMax",function(c,b){var d=b.id.split("-")[1];d=a("#max-"+d).val();return this.optional(b)||parseFloat(c)<=d},"needs to be lower than Maximum");a.validator.addMethod("greaterThanMin",function(c,
b){var d=b.id.split("-")[1];d=a("#min-"+d).val();return this.optional(b)||parseFloat(c)>=d},"needs to be higher than Minimum");this.refresh()},addQuestion:function(a,c,g,b){if("instructions"==g)b?this._addQuestion(a,c,g,null,!0):this._addQuestion(a,c,g);else if(b)this._addQuestion(a,c,g,b,!0);else{var d=this;b=S3.Ap.concat("/dc/question/create_json.json");var e=JSON.stringify({type:K[g],template_id:this.recordID});this.ajaxMethod({url:b,type:"POST",data:e,dataType:"json",success:function(b){d._addQuestion(a,
c,g,b.question_id)},error:function(a,b,d){console.log("UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText)}})}},_addQuestion:function(e,c,g,b,d){var q=this.data.l10n;if(d)for(var f=1,l=Object.keys(C).length;f<=l;f++){if(e==C[f]){var m=f;break}}else"instructions"==g?this.data.layout[e]={type:"instructions",do:{text:""},say:{text:""}}:(m=Object.keys(C).length+1,C[m]=e,this.data.layout[e]={type:"question",id:b},this.data.questions[b]={type:K[g],settings:{}}),this.saveLayout();l="";var h;q&&(l='<li class="tab-title"><a href="#translation-'+
e+'">Translation</a></li>');if("instructions"==g){var k="instruction-"+e;var I=""}else{k="question-"+b;I=' data-number="'+m+'"';var B="";var t=this.data.questions[b];d&&t.mandatory&&(B=" checked");B='<div class="row"><input id="mandatory-'+b+'" type="checkbox" '+B+' class="fleft"><label>Make question mandatory</label></div>';if("heatmap"!=g){f=this.pipeOptionsHtml(b,d);var F='<div class="row"><label>Add image</label><span id="preview-'+b+'" class="preview-empty fleft"></span><label for="image-'+b+
'" class="button tiny fleft">Upload image</label><input id="image-'+b+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"><label class="fleft">or pipe question image:</label><select id="pipe-'+b+'" class="fleft">'+f+'</select><a id="image-delete-'+b+'">Delete</a></div>'}}k='<div class="thumbnail dl-item" id="'+k+'" data-page="'+c+'"'+I+'><div class="card-header"><ul class="tabs fleft" data-tab><li class="tab-title active"><a href="#edit-'+e+'">Edit</a></li><li class="tab-title"><a href="#logic-'+
e+'">Display Logic</a></li> '+l+'</ul><div class="edit-bar fright"><a><i class="ucce ucce-duplicate"> </i></a><a><i class="ucce ucce-delete"> </i></a><i class="ucce ucce-up"> </i><i class="ucce ucce-down"> </i></div></div><div class="tabs-content">';f=this.logicOptionsHtml(b,d);I='<div class="media content" id="logic-'+e+'"><h2>Only display question if...</h2><select id="logic-select-'+b+'" class="fleft">'+f+"</select><label>response is</label></div>";switch(g){case "instructions":F=h=m=B="";if(d){var r=
this.data.layout[e];B=r.do.text;h=r.say.text;q&&r.do.l10n&&(m=r.do.l10n[q],F=r.say.l10n[q])}r='<div class="media content active" id="edit-'+e+'"><h2>Data collector instructions</h2><label>What to do</label><input id="do-'+e+'" type="text" size=100 placeholder="Type what instructor should do" value="'+B+'"><label>What to say</label><input id="say-'+e+'" type="text" size=100 placeholder="Type what instructor should say" value="'+h+'"></div>';var v='<div class="media content" id="translation-'+e+'"><h2>Data collector instructions</h2><label>What to do</label><input id="do-l10n-'+
e+'" type="text" size=100 placeholder="Type translation of what instructor should do" value="'+m+'"><label>What to say</label><input id="say-l10n-'+e+'" type="text" size=100 placeholder="Type translation of what instructor should say" value="'+F+'"></div>';var G="#instruction-"+e+" input";h="#instruction-"+e+" .ucce-delete";break;case "text":h=r="";d&&(r=t.name,q&&(h=t.name_l10n||""));r='<div class="media content active" id="edit-'+e+'"><h2>Text box</h2><div class="row"><label id="qlabel-'+b+'" class="fleft">Q'+
m+'</label><input id="name-'+b+'" type="text" size=100 placeholder="type question" value="'+r+'"></div>'+B+F+"</div>";v='<div class="media content" id="translation-'+e+'"><h2>Text box</h2><div class="row"><label id="qlabel-l10n-'+b+'" class="fleft">Q'+m+'</label><input id="name-l10n-'+b+'" type="text" size=100 placeholder="type translated question" value="'+h+'"></div></div>';G="#question-"+b+" input, #question-"+b+" select";h="#question-"+b+" .ucce-delete";break;case "number":v=l=h=r="";d&&(r=t.name,
q&&(h=t.name_l10n||""),f=t.settings||{},f=(f.requires||{}).isIntInRange)&&(l=f.min||"",v=f.max||"");r='<div class="media content active" id="edit-'+e+'"><h2>Number question</h2><div class="row"><label id="qlabel-'+b+'" class="fleft">Q'+m+'</label><input id="name-'+b+'"type="text" size=100 placeholder="type question" value="'+r+'"></div>'+B+F+'<div class="row"><h2>Answer</h2><form id="answer-'+b+'"><label>Minimum:</label><input id="min-'+b+'" name="min" type="number" value="'+l+'"><label>Maximum:</label><input id="max-'+
b+'" name="max" type="number" value="'+v+'"></form></div></div>';v='<div class="media content" id="translation-'+e+'"><h2>Number question</h2><div class="row"><label id="qlabel-l10n-'+b+'" class="fleft">Q'+m+'</label><input id="name-l10n-'+b+'"type="text" size=100 placeholder="type translated question" value="'+h+'"></div';G="#question-"+b+" input, #question-"+b+" select";h="#question-"+b+" .ucce-delete";break;case "multichoice":var L='<div class="row"><input class="choice-'+b+'" type="text" placeholder="Enter an answer choice"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div>';
h=r="";l=L;v="";var H=" disabled",D="";f=1;var M="";if(d){r=t.name;q&&(h=t.name_l10n||"");D=t.options||[];var N=D.length;if(N)for(l="",f=0;f<N;f++)l+='<div class="row"><input class="choice-'+b+'" type="text" placeholder="Enter an answer choice" value="'+D[f]+'"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div>';f=t.settings;if(D=f.other||"")v=" checked",H="";f=f.multiple||1;1<f&&(M=" checked")}r='<div class="media content active" id="edit-'+e+'"><h2>Multiple choice question</h2><div class="row"><label id="qlabel-'+
b+'" class="fleft">Q'+m+'</label><input id="name-'+b+'"type="text" size=100 placeholder="type question" value="'+r+'"></div>'+B+F+'<div class="row"><h2>Answer</h2><label>Choices</label></div>'+l+'<div class="row"><input id="other-'+b+'" type="checkbox"'+v+'><label>Add \'other field\'</label></div><div class="row"><label class="fleft">Field label</label><input id="other-label-'+b+'" type="text" placeholder="Other (please specify)" value="'+D+'"'+H+'></div><div class="row"><input id="multiple-'+b+'" type="checkbox"'+
M+'><label>Allow multiple responses</label></div><div class="row"><label class="fleft">Maximum No. of responses:</label><i class="ucce ucce-minus"> </i> <span id="multiple-count-'+b+'">'+f+'</span> <i class="ucce ucce-plus"> </i></div></div>';v='<div class="media content" id="translation-'+e+'"><h2>Multiple choice question</h2><div class="row"><label id="qlabel-l10n-'+b+'" class="fleft">Q'+m+'</label><input id="name-l10n-'+b+'"type="text" size=100 placeholder="type translated question" value="'+h+
'"></div';G="#question-"+b+" input, #question-"+b+" select";h="#question-"+b+" .ucce-delete";break;case "likert":v=h=r="";H=['<option value="1">Agreement (Disagree - Agree)</option>','<option value="2">Satisfaction (Smiley scale)</option>','<option value="3">Satisfaction (Dissatisfied - Satisfied)</option>','<option value="4">Pain scale (3 point)</option>'];if(d&&(r=t.name,q&&(h=t.name_l10n||""),(f=t.settings)&&f.hasOwnProperty("scale")&&(f=f.scale))){H[f-1]=H[f-1].replace('">','" selected>');D=u[f];
v+="<ul>";f=0;for(l=D.length;f<l;f++)v+="<li>"+D[f]+"</li>";v+="</ul>"}f=H.join();r='<div class="media content active" id="edit-'+e+'"><h2>Likert-scale</h2><div class="row"><label id="qlabel-'+b+'" class="fleft">Q'+m+'</label><input id="name-'+b+'"type="text" size=100 placeholder="type question" value="'+r+'"></div>'+B+F+'<div class="row"><h2>Answer</h2><label>Choices</label><select id="scale-'+b+'"><option value="">Please choose scale</option>'+f+'</select></div><div class="row">'+v+"</div></div>";
v='<div class="media content" id="translation-'+e+'"><h2>Likert-scale</h2><div class="row"><label id="qlabel-l10n-'+b+'" class="fleft">Q'+m+'</label><input id="name-l10n-'+b+'"type="text" size=100 placeholder="type translated question" value="'+h+'"></div';G="#question-"+b+" input, #question-"+b+" select";h="#question-"+b+" .ucce-delete";break;case "heatmap":h=r="",d&&(r=t.name,q&&(h=t.name_l10n||"")),r='<div class="media content active" id="edit-'+e+'"><h2>Heatmap</h2><div class="row"><label id="qlabel-'+
b+'" class="fleft">Q'+m+'</label><input id="name-'+b+'"type="text" size=100 placeholder="type question" value="'+r+'"></div>'+B+'<div class="row"><h2>Image</h2><span id="preview-'+b+'" class="preview-empty fleft"></span><label for="image-'+b+'" class="button tiny fleft">Upload image</label><input id="image-'+b+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"><h3>Number of clicks allowed:</h3><i class="ucce ucce-minus"> </i> 1 <i class="ucce ucce-plus"> </i><h3>Tap/click regions:</h3><a class="button tiny">Add region</a><input id="region-'+
e+'-1" type="text" placeholder="enter label" disabled></div></div>',v='<div class="media content" id="translation-'+e+'"><h2>Heatmap</h2><div class="row"><label id="qlabel-l10n-'+b+'" class="fleft">Q'+m+'</label><input id="name-l10n-'+b+'"type="text" size=100 placeholder="type translated question" value="'+h+'"></div',G="#question-"+b+" input",h="#question-"+b+" .ucce-delete"}k=k+r+I;q&&(k+=v);k+="</div></div>";a("#survey-droppable-"+e).before(k);k=e+1;a("#survey-droppable-"+e).attr("id","survey-droppable-"+
k);A[c]++;a("#section-break-"+z[c]+" > span").html("PAGE "+c+" ("+A[c]+" ELEMENTS)");var x=this.eventNamespace,w=this,O=function(){a(G).off("change"+x).on("change"+x,function(){if("instructions"==g){var d=this.id.split("-");d=parseInt(d[d.length-1]);var c=w.data.layout[d];c.do.text=a("#do-"+d).val();c.say.text=a("#say-"+d).val();q&&(c.do.hasOwnProperty("10n")||(c.do.l10n={}),c.do.l10n[q]=a("#do-l10n-"+d).val(),c.say.hasOwnProperty("10n")||(c.say.l10n={}),c.say.l10n[q]=a("#say-l10n-"+d).val());w.saveLayout()}else w.saveQuestion(g,
b)});if("instructions"!=g&&"heatmap"!=g)a("#pipe-"+b).on("change"+x,function(){var d=a(this).val();if(d){for(var c,e=0,f=p.length;e<f;e++)if(c=p[e],c.label==d){t.settings.pipeImage={id:c.id,region:c.region};break}w.deleteImage(b)}else delete t.settings.pipeImage;w.saveQuestion(g,b)})};O();"instructions"!=g&&(d&&(c=t.file)&&n(S3.Ap.concat("/default/download/"+c),function(d){var c=n.scale(d,{canvas:!0,maxHeight:80,maxWidth:80});a("#preview-"+b).removeClass("preview-empty").empty().append(c);return d},
{}),a("#image-delete-"+b).on("click"+x,function(){w.deleteImage(b)}),a("#image-"+b).fileupload({dataType:"json",dropZone:a("#preview-"+b+", #image-"+b),maxNumberOfFiles:1,url:S3.Ap.concat("/dc/question/")+b+"/image_upload.json",add:function(d,c){if(d.isDefaultPrevented())return!1;(c.autoUpload||!1!==c.autoUpload&&a(this).fileupload("option","autoUpload"))&&c.process().done(function(){c.submit();n(c.files[0],function(d){var c=n.scale(d,{canvas:!0,maxHeight:80,maxWidth:80});a("#preview-"+b).removeClass("preview-empty").empty().append(c);
c=t.type;if(13!=c){t.settings.hasOwnProperty("pipeImage")&&a("#pipe-"+b).val("").trigger("change");var e=!1;for(d in p)d.id==b&&(e=!0);e||(c="Q"+a("#question-"+b).data("number")+" "+J[c],p.push({label:c,id:b}));c=w.data.questions;e=w.data.layout;for(var g=1;g<=Object.keys(e).length;g++){var f=e[g];if("question"==f.type){f=f.id;var h=c[f];13!=h.type&&a("#pipe-"+f).empty().append(w.pipeOptionsHtml(f))}}}return d},{})})}}));a(h).on("click"+x,function(){w.deleteQuestion(g,b,this)});switch(g){case "number":a("#answer-"+
b).validate({rules:{min:{required:!1,digits:!0,lessThanMax:!0},max:{required:!1,digits:!0,greaterThanMin:!0}},messages:{min:{digits:"Only integers allowed"},max:{digits:"Only integers allowed"}},errorClass:"req",focusCleanup:!0});break;case "multichoice":var E=a("#multiple-"+b),y=a("#multiple-count-"+b),P=function(){a(".choice-"+b).next().off("click"+x).on("click"+x,function(){if(1<a(".choice-"+b).length){a(this).parent().remove();var c=parseInt(y.html()),d=a(".choice-"+b).length;a("#other-"+b).prop("checked")&&
d++;c>d&&(y.html(d),1==d&&E.prop("checked",!1));w.saveQuestion(g,b)}else a(this).prev().val("")});a(".choice-"+b).next().next().off("click"+x).on("click"+x,function(){a(this).parent().after(L);O();P()});a("#other-"+b).on("change"+x,function(){if(a(this).prop("checked"))a("#other-label-"+b).prop("disabled",!1);else{a("#other-label-"+b).prop("disabled",!0);var d=parseInt(y.html()),c=a(".choice-"+b).length;d>c&&(y.html(c),1==c&&E.prop("checked",!1))}});E.on("change"+x,function(){if(E.prop("checked")){parseInt(y.html());
var c=a(".choice-"+b).length;a("#other-"+b).prop("checked")&&c++;1<c?y.html(2):E.prop("checked",!1)}else y.html(1);w.saveQuestion(g,b)});y.prev().on("click"+x,function(){if(E.prop("checked")){var a=parseInt(y.html());2<a?(y.html(a-1),w.saveQuestion(g,b)):2==a&&(y.html(1),E.prop("checked",!1),w.saveQuestion(g,b))}});y.next().on("click"+x,function(){if(E.prop("checked")){var c=parseInt(y.html()),d=a(".choice-"+b).length;a("#other-"+b).prop("checked")&&d++;c<d&&(y.html(c+1),w.saveQuestion(g,b))}})};
P();break;case "likert":a("#scale-"+b).on("change"+x,function(){var b=a(this),c=b.val();if(c){c=u[c];for(var d="",e=0,g=c.length;e<g;e++)d+="<li>"+c[e]+"</li>";c="<ul>"+d+"</ul>";b.parent().next().empty().append(c)}else b.parent().next().empty()})}"instructions"==g?a("#instruction-"+e).foundation():a("#question-"+b).foundation()},deleteQuestion:function(e,c,g){if("instructions"==e){g=parseInt(a(g).closest(".dl-item").attr("id").split("-")[1]);var b=a("#instruction-"+g).data("page")}else g=a("#question-"+
c).data("number"),g=C[g],b=a("#question-"+c).data("page");A[b]--;a("#section-break-"+z[b]+" > span").html("PAGE "+b+" ("+A[b]+" ELEMENTS)");var d=b+1;for(b=Object.keys(z).length;d<=b;d++)z[d]--;var q,f,l=this.data.layout,m=Object.keys(l).length;for(d=g;d<m;d++){b=d+1;var h=l[b];l[d]=h;if("break"==h.type)a("#section-break-"+b).attr("id","section-break-"+d);else{if("question"==h.type){var k=h.id;h=a("#question-"+k);var p=h.data("number");if("instructions"==e)C[p]=d;else{var n=p-1;h.data("number",n);
a("#qlabel-"+k).html("Q"+n);a("#qlabel-l10n-"+k).html("Q"+n);C[n]=d}}else a("#instruction-"+b).attr("id","instruction-"+d),h=a("#instruction-"+d),a("#do-"+b).attr("id","do-"+d),a("#say-"+b).attr("id","say-"+d),a("#do-l10n-"+b).attr("id","do-l10n-"+d),a("#say-l10n-"+b).attr("id","say-l10n-"+d);a("#edit-"+b).attr("id","edit-"+d);a("#logic-"+b).attr("id","logic-"+d);a("#translation-"+b).attr("id","translation-"+d);h.find("li.tab-title > a").each(function(){var b=a(this);q=b.attr("href");f=q.split("-")[0];
f=f.substring(1,f.length);b.attr("href","#"+f+"-"+d)})}}delete l[m];"instructions"!=e&&delete C[p];this.saveLayout();"instructions"==e?a("#instruction-"+g).remove():a("#question-"+c).remove();a("#survey-droppable-"+(m+1)).attr("id","survey-droppable-"+m);"instructions"!=e&&(e=S3.Ap.concat("/dc/question/")+c+"/delete.json",this.ajaxMethod({url:e,type:"POST",dataType:"json",success:function(){},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}}))},pipeOptionsHtml:function(a,
c){var e=this.data.questions[a];c='<option value="">select question</option>';if(e&&e.settings&&e.settings.pipeImage)var b=e.settings.pipeImage;for(var d=0,q=p.length;d<q;d++)e=p[d],e.id!=a&&(c=b&&b.id==e.id&&b.region==e.region?c+("<option selected>"+e.label+"</option>"):c+("<option>"+e.label+"</option>"));return c},logicOptionsHtml:function(a,c){return'<option value="">select question</option>'},deleteImage:function(e){var c=this,g=a("#preview-"+e);if(!g.hasClass("preview-empty")){var b=S3.Ap.concat("/dc/question/")+
e+"/image_delete.json";this.ajaxMethod({url:b,type:"POST",dataType:"json",success:function(){g.empty().addClass("preview-empty");var b=p;p=[];for(var q=0,f=b.length;q<f;q++){var l=b[q];l.id!=e&&p.push(l)}l=c.data.questions;b=c.data.layout;for(q=1;q<=Object.keys(b).length;q++)if(f=b[q],"question"==f.type){f=f.id;var m=l[f];13!=m.type&&a("#pipe-"+f).empty().append(c.pipeOptionsHtml(f))}},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}},addSectionBreak:function(e,
c,g){c++;z[c]=e;A[c]=0;var b='<div class="row"><div class="section-break medium-11 columns" id="section-break-'+e+'" data-page="'+c+'"><span>PAGE '+c+' (0 ELEMENTS)</span></div><div class="medium-1 columns">'+(e?'<i class="ucce ucce-delete-page"> </i>':"")+'<i class="ucce ucce-down-alt"> </i></div></div>';if(e){a("#survey-droppable-"+e).before(b);b=e+1;a("#survey-droppable-"+e).data("page",c).attr("id","survey-droppable-"+b);g||(this.data.layout[e]={type:"break"},this.saveLayout());var d=this;c=this.eventNamespace;
a("#section-break-"+e).next().children(".ucce-delete-page").on("click"+c,function(){var b=parseInt(a(this).parent().prev().attr("id").split("-")[2]);d.deleteSectionBreak(b)})}else a(this.element).parent().append(b)},deleteSectionBreak:function(e){var c=a("#section-break-"+e).data("page"),g=A[c];if(g){var b=c-1;A[b]+=g;a("#section-break-"+z[b]+" > span").html("PAGE "+b+" ("+A[b]+" ELEMENTS)")}g=Object.keys(z).length;for(var d=c;d<g;d++)z[d]=z[d+1]-1,A[d]=A[d+1];delete z[g];delete A[g];c=this.data.layout;
b=Object.keys(c).length;if(e!=b){var q,f;for(d=e;d<b;d++){var l=d+1;var m=c[l];c[d]=m;if("break"==m.type)m=a("#section-break-"+l).data("page")-1,a("#section-break-"+l).data("page",m),a("#section-break-"+l+" > span").html("PAGE "+m+" ("+A[m]+" ELEMENTS)"),a("#section-break-"+l).attr("id","section-break-"+d);else{if("question"==m.type){var h=a("#question-"+m.id);m=h.data("number");C[m]=d}else a("#instruction-"+l).attr("id","instruction-"+d),h=a("#instruction-"+d),a("#do-"+l).attr("id","do-"+d),a("#say-"+
l).attr("id","say-"+d),a("#do-l10n-"+l).attr("id","do-"+d),a("#say-l10n-"+l).attr("id","say-"+d);a("#edit-"+l).attr("id","edit-"+d);a("#logic-"+l).attr("id","logic-"+d);a("#translation-"+l).attr("id","translation-"+d);h.find("li.tab-title > a").each(function(){var b=a(this);q=b.attr("href");f=q.split("-")[0];f=f.substring(1,f.length);b.attr("href","#"+f+"-"+d)})}}}delete c[b];this.saveLayout();a("#section-break-"+e).parent().remove();a("#survey-droppable-"+(b+1)).data("page",g-1).attr("id","survey-droppable-"+
b)},droppable:function(e,c){var g=this;c='<div class="survey-droppable" id="survey-droppable-'+e+'" data-page="'+c+'"><span>Drag and drop questions here</span></div>';a(this.element).parent().append(c);a("#survey-droppable-"+e).droppable({drop:function(b,c){b=c.draggable[0].id;c=parseInt(this.id.split("-")[2]);var d=a(this).data("page");"break"==b?g.addSectionBreak(c,d):g.addQuestion(c,d,b)}})},_destroy:function(){a.Widget.prototype.destroy.call(this)},loadSurvey:function(){var a=this.data.layout;
if(a){for(var c,g=1,b=0,d,k,f,l=this.data.questions,m=Object.keys(a).length,h=1;h<=m;h++)if(c=a[h],"break"!=c.type&&"instructions"!=c.type&&(b++,C[b]=h,c=c.id,d=l[c],d.file))if(13==d.type){if(d=d.settings.regions){k="Q"+b+" Heatmap; ";for(var n=0,u=d.length;n<u;n++)f=k+"'"+d[n].label+"'",p.push({label:f,id:c,region:n})}}else f="Q"+b+" "+J[d.type],p.push({label:f,id:c});for(h=1;h<=m;h++)c=a[h],"break"==c.type?(this.addSectionBreak(h,g,!0),g++):"instructions"==c.type?this.addQuestion(h,g,"instructions",
!0):(c=c.id,this.addQuestion(h,g,J[l[c].type],c))}},refresh:function(){this._deserialize();this.addSectionBreak(0,0);this.droppable(1,1);this.loadSurvey()},saveQuestion:function(e,c){var g=a("#name-"+c).val();if(g){var b=S3.Ap.concat("/dc/question/")+c+"/update_json.json",d={};g={name:g,mandatory:a("#mandatory-"+c).prop("checked")};var k=this.data.questions[c].settings.pipeImage;k&&(d.pipeImage=k);switch(e){case "number":a("#min-"+c).hasClass("req")?e=null:(e=a("#min-"+c).val())&&(e=parseInt(e));
a("#max-"+c).hasClass("req")?c=null:(c=a("#max-"+c).val())&&(c=parseInt(c));d.requires={isIntInRange:{min:e,max:c}};break;case "multichoice":var f=[];a(".choice-"+c).each(function(){f.push(a(this).val())});g.options=f;a("#other-"+c).prop("checked")?d.other=a("#other-label-"+c).val():d.other=null;a("#multiple-"+c).prop("checked")?d.multiple=parseInt(a("#multiple-count-"+c).html()):d.multiple=1;break;case "likert":(c=a("#scale-"+c).val())?(g.options=u[c],d.scale=c):(g.options=[],d.scale=null)}g.settings=
d;this.ajaxMethod({url:b,type:"POST",data:JSON.stringify(g),dataType:"json",success:function(){},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}},saveLayout:function(){var a=S3.Ap.concat("/dc/template/")+this.recordID+"/update_json.json";this.ajaxMethod({url:a,type:"POST",data:JSON.stringify({layout:this.data.layout}),dataType:"json",success:function(){},error:function(a,e,b){console.log("UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText)}})},
_deserialize:function(){var e=a(this.element).val()||"{}";return this.data=JSON.parse(e)}})});
