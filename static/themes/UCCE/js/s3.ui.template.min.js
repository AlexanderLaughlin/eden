var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var l=0;return function(){return l<a.length?{done:!1,value:a[l++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,l,n){a!=Array.prototype&&a!=Object.prototype&&(a[l]=n.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(a,l){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:l})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(n){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(n||"")+"_"+l++,n)}var l=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,l){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var n=0,g={next:function(){if(n<a.length){var t=n++;return{value:l(t,a[t]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill=function(a,l,n,g){if(l){n=$jscomp.global;a=a.split(".");for(g=0;g<a.length-1;g++){var t=a[g];t in n||(n[t]={});n=n[t]}a=a[a.length-1];g=n[a];l=l(g);l!=g&&null!=l&&$jscomp.defineProperty(n,a,{configurable:!0,writable:!0,value:l})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.findInternal=function(a,l,n){a instanceof String&&(a=String(a));for(var g=a.length,t=0;t<g;t++){var w=a[t];if(l.call(n,w,t,a))return{i:t,v:w}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,n){return $jscomp.findInternal(this,a,n).v}},"es6","es3");$jscomp.checkEs6ConformanceViaProxy=function(){try{var a={},l=Object.create(new $jscomp.global.Proxy(a,{get:function(n,g,t){return n==a&&"q"==g&&t==l}}));return!0===l.q}catch(n){return!1}};
$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS=!1;$jscomp.ES6_CONFORMANCE=$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS&&$jscomp.checkEs6ConformanceViaProxy();$jscomp.makeIterator=function(a){var l="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return l?l.call(a):$jscomp.arrayIterator(a)};$jscomp.owns=function(a,l){return Object.prototype.hasOwnProperty.call(a,l)};
$jscomp.polyfill("WeakMap",function(a){function l(){if(!a||!Object.seal)return!1;try{var D=Object.seal({}),b=Object.seal({}),d=new a([[D,2],[b,3]]);if(2!=d.get(D)||3!=d.get(b))return!1;d.delete(D);d.set(b,4);return!d.has(D)&&4==d.get(b)}catch(p){return!1}}function n(){}function g(a){var b=typeof a;return"object"===b&&null!==a||"function"===b}function t(a){if(!$jscomp.owns(a,r)){var b=new n;$jscomp.defineProperty(a,r,{value:b})}}function w(a){var b=Object[a];b&&(Object[a]=function(a){if(a instanceof
n)return a;t(a);return b(a)})}if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(a&&$jscomp.ES6_CONFORMANCE)return a}else if(l())return a;var r="$jscomp_hidden_"+Math.random();w("freeze");w("preventExtensions");w("seal");var A=0,y=function(a){this.id_=(A+=Math.random()+1).toString();if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};y.prototype.set=function(a,b){if(!g(a))throw Error("Invalid WeakMap key");t(a);if(!$jscomp.owns(a,r))throw Error("WeakMap key fail: "+
a);a[r][this.id_]=b;return this};y.prototype.get=function(a){return g(a)&&$jscomp.owns(a,r)?a[r][this.id_]:void 0};y.prototype.has=function(a){return g(a)&&$jscomp.owns(a,r)&&$jscomp.owns(a[r],this.id_)};y.prototype.delete=function(a){return g(a)&&$jscomp.owns(a,r)&&$jscomp.owns(a[r],this.id_)?delete a[r][this.id_]:!1};return y},"es6","es3");$jscomp.MapEntry=function(){};
$jscomp.polyfill("Map",function(a){function l(){if($jscomp.ASSUME_NO_NATIVE_MAP||!a||"function"!=typeof a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var y=Object.seal({x:4}),g=new a($jscomp.makeIterator([[y,"s"]]));if("s"!=g.get(y)||1!=g.size||g.get({x:4})||g.set({x:4},"t")!=g||2!=g.size)return!1;var b=g.entries(),d=b.next();if(d.done||d.value[0]!=y||"s"!=d.value[1])return!1;d=b.next();return d.done||4!=d.value[0].x||"t"!=d.value[1]||!b.next().done?!1:!0}catch(p){return!1}}
if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(a&&$jscomp.ES6_CONFORMANCE)return a}else if(l())return a;$jscomp.initSymbolIterator();var n=new WeakMap,g=function(a){this.data_={};this.head_=r();this.size=0;if(a){a=$jscomp.makeIterator(a);for(var y;!(y=a.next()).done;)y=y.value,this.set(y[0],y[1])}};g.prototype.set=function(a,g){a=0===a?0:a;var b=t(this,a);b.list||(b.list=this.data_[b.id]=[]);b.entry?b.entry.value=g:(b.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:a,
value:g},b.list.push(b.entry),this.head_.previous.next=b.entry,this.head_.previous=b.entry,this.size++);return this};g.prototype.delete=function(a){a=t(this,a);return a.entry&&a.list?(a.list.splice(a.index,1),a.list.length||delete this.data_[a.id],a.entry.previous.next=a.entry.next,a.entry.next.previous=a.entry.previous,a.entry.head=null,this.size--,!0):!1};g.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=r();this.size=0};g.prototype.has=function(a){return!!t(this,a).entry};
g.prototype.get=function(a){return(a=t(this,a).entry)&&a.value};g.prototype.entries=function(){return w(this,function(a){return[a.key,a.value]})};g.prototype.keys=function(){return w(this,function(a){return a.key})};g.prototype.values=function(){return w(this,function(a){return a.value})};g.prototype.forEach=function(a,g){for(var b=this.entries(),d;!(d=b.next()).done;)d=d.value,a.call(g,d[1],d[0],this)};g.prototype[Symbol.iterator]=g.prototype.entries;var t=function(a,g){var b=g&&typeof g;"object"==
b||"function"==b?n.has(g)?b=n.get(g):(b=""+ ++A,n.set(g,b)):b="p_"+g;var d=a.data_[b];if(d&&$jscomp.owns(a.data_,b))for(a=0;a<d.length;a++){var p=d[a];if(g!==g&&p.key!==p.key||g===p.key)return{id:b,list:d,index:a,entry:p}}return{id:b,list:d,index:-1,entry:void 0}},w=function(a,g){var b=a.head_;return $jscomp.iteratorPrototype(function(){if(b){for(;b.head!=a.head_;)b=b.previous;for(;b.next!=b.head;)return b=b.next,{done:!1,value:g(b)};b=null}return{done:!0,value:void 0}})},r=function(){var a={};return a.previous=
a.next=a.head=a},A=0;return g},"es6","es3");
(function(a){a(window.jQuery,window.loadImage)})(function(a,l){var n=0,g=[],t={1:["Strongly Disagree","Disagree","Undecided","Agree","Strongly Agree"],2:["Very unsatisfied","Unsatisfied","Neutral","Satisfied","Very satisfied"],3:["Very dissatisfied","Dissatisfied","Neutral","Satisfied","Very satisfied"],4:["Pain","Neutral","No Pain"]},w={},r={},A={},y={text:1,number:2,multichoice:6,likert:12,heatmap:13},D={1:"text",2:"number",6:"multichoice",12:"likert",13:"heatmap"};a.widget("s3.surveyLayout",{options:{},
_create:function(){this.id=n;n+=1;this.eventNamespace=".surveyEditor"},_init:function(){var b=a(this.element),d=b.attr("id");d||(d="surveyEditor-widget-"+this.id);this.fieldname=d;this.recordID=b.data("id");this.data=null;this.ajaxMethod=void 0!==a.searchS3?a.searchS3:a.ajaxS3;a.validator.addMethod("lessThanMax",function(b,c){var d=c.id.split("-")[1];d=a("#max-"+d).val();return""==d?this.optional(c)||!0:this.optional(c)||parseFloat(b)<=d},"needs to be lower than Maximum");a.validator.addMethod("greaterThanMin",
function(b,c){var d=c.id.split("-")[1];d=a("#min-"+d).val();return""==d?this.optional(c)||!0:this.optional(c)||parseFloat(b)>=d},"needs to be higher than Minimum");this.refresh()},addQuestion:function(a,d,p,c){if("instructions"==p)c?this._addQuestion(a,d,p,null,!0):this._addQuestion(a,d,p);else if(c)this._addQuestion(a,d,p,c,!0);else{var b=this;c=S3.Ap.concat("/dc/question/create_json.json");var k=JSON.stringify({type:y[p],template_id:this.recordID});this.ajaxMethod({url:c,type:"POST",data:k,dataType:"json",
success:function(c){b._addQuestion(a,d,p,c.question_id)},error:function(a,c,b){console.log("UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText)}})}},_addQuestion:function(b,d,p,c,e){var k=this.data.l10n;if(e)for(var m=1,h=Object.keys(A).length;m<=h;m++){if(b==A[m]){var f=m;break}}else"instructions"==p?this.data.layout[b]={type:"instructions",do:{text:""},say:{text:""}}:(f=Object.keys(A).length+1,A[f]=b,this.data.layout[b]={type:"question",id:c},this.data.questions[c]={type:y[p],settings:{},options:[]}),
this.saveLayout();var N="",q;k||(N=" hide");var n='<li class="tab-title l10n'+N+'"><a href="#translation-'+b+'">Translation</a></li>';if("instructions"==p){var P="instruction-"+b;var J="";var D="#instruction-"+b+" input, #instruction-"+b+" select";N="#instruction-"+b+" .ucce-delete"}else{P="question-"+c;J=' data-number="'+f+'"';D="#question-"+c+" input, #question-"+c+" select";N="#question-"+c+" .ucce-delete";var F="";var u=this.data.questions[c];e&&u.mandatory&&(F=" checked");F='<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="mandatory-'+
c+'" type="checkbox" '+F+' class="fleft"><label>Make question mandatory</label></div></div>';if("heatmap"!=p){var E=this.pipeOptionsHtml(c);E='<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Add image</label><span id="preview-'+c+'" class="preview-empty fleft"></span><label for="image-'+c+'" class="button tiny fleft">Upload image</label><input id="image-'+c+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"><label class="fleft">or pipe question image:</label><select id="pipe-'+
c+'" class="fleft">'+E+'</select><a id="image-delete-'+c+'">Delete</a></div></div>'}}J='<div class="thumbnail dl-item" id="'+P+'" data-page="'+d+'"'+J+'><div class="card-header"><ul class="tabs fleft" data-tab><li class="tab-title active"><a href="#edit-'+b+'">Edit</a></li><li class="tab-title"><a href="#logic-'+b+'">Display logic</a></li> '+n+'</ul><div class="edit-bar fright"><a><i class="ucce ucce-duplicate"> </i></a><a><i class="ucce ucce-delete"> </i></a><i class="ucce ucce-up"> </i><i class="ucce ucce-down"> </i></div></div><div class="tabs-content">';
P='<div class="media content" id="logic-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Only display question if...</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><select id="logic-select-'+b+'"></select></div></div><div class="row" id="logic-response-row-'+b+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-2"><label class="fleft">response is</label></div><div class="columns medium-10" id="logic-response-'+
b+'"></div></div></div></div></div>';switch(p){case "instructions":F=q=f=E="";if(e){var v=this.data.layout[b];E=v.do.text;q=v.say.text;k&&v.do.l10n&&(f=v.do.l10n[k],F=v.say.l10n[k])}v='<div class="media content active" id="edit-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Data collector instructions</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>What instructor should do</label><input id="do-'+
b+'" type="text" size=100 placeholder="Type what instructor should do" value="'+E+'"><label>What instructor should say</label><input id="say-'+b+'" type="text" size=100 placeholder="Type what instructor should say" value="'+q+'"></div></div></div>';q='<div class="media content" id="translation-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Data collector instructions</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>What instructor should do</label><div class="translate-from"></div><input id="do-l10n-'+
b+'" type="text" size=100 placeholder="Type translation..." value="'+f+'"><label>What instructor should say</label><div class="translate-from"></div><input id="say-l10n-'+b+'" type="text" size=100 placeholder="Type translation..." value="'+F+'"></div></div></div>';break;case "text":q=v="";e&&(v=u.name,k&&(q=u.name_l10n||""));v='<div class="media content active" id="edit-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Text box</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+
c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><input id="name-'+c+'" type="text" size=100 placeholder="type question" value="'+v+'"></div></div>'+F+E+"</div>";q='<div class="media content" id="translation-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Text box</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+
c+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+c+'" type="text" size=100 placeholder="type translated question" value="'+q+'"></div></div></div>';break;case "number":h=n=q=v="";e&&(v=u.name,k&&(q=u.name_l10n||""),m=u.settings||{},m=(m.requires||{}).isIntInRange)&&(n=m.min||"",h=m.max||"");v='<div class="media content active" id="edit-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Number question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+
c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><input id="name-'+c+'"type="text" size=100 placeholder="type question" value="'+v+'"></div></div>'+F+E+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Restrict input to:</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><form id="answer-'+
c+'"><label class="fleft">Minimum:</label><input id="min-'+c+'" name="min" type="number" value="'+n+'" class="fleft"><label class="fleft">Maximum:</label><input id="max-'+c+'" name="max" type="number" value="'+h+'" class="fleft"></form></div></div></div>';q='<div class="media content" id="translation-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Number question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+
c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+c+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+c+'" type="text" size=100 placeholder="type translated question" value="'+q+'"></div></div></div>';break;case "multichoice":var L='<div id="choice-row-'+c+'-0" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input class="choice-'+
c+'" type="text" placeholder="Enter an answer choice"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div></div>';q=v="";h=L;var M=n="",R=" disabled",B="",H="";m=1;var S="";if(e){v=u.name;k&&(q=u.name_l10n||"");B=u.options||[];H=u.options_l10n||[];var G=B.length;if(G)for(h="",m=0;m<G;m++){h+='<div id="choice-row-'+c+"-"+m+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input class="choice-'+c+'" type="text" placeholder="Enter an answer choice" value="'+
B[m]+'"><i class="ucce ucce-minus"> </i><i class="ucce ucce-plus"> </i></div></div>';var K=H[m]||"";K='<div id="choice-l10n-row-'+c+"-"+m+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+c+"-"+m+'" class="translate-from">'+B[m]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+c+'" type="text" placeholder="Type translation..." value="'+K+'"></div></div></div></div>';n+=K}m=u.settings;
H="";G=" hide";if(B=m.other||"")M=" checked",R="",H=m.otherL10n||"",G="";n+='<div id="other-l10n-row-'+c+'" class="row'+G+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="other-l10n-from-'+c+'" class="translate-from">'+B+'</div></div><div class="columns medium-6"><input id="other-l10n-'+c+'" type="text" placeholder="Type translation..." value="'+H+'"></div></div></div></div>';m=m.multiple||1;1<m&&(S=" checked")}v='<div class="media content active" id="edit-'+
b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Multiple choice question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><input id="name-'+c+'"type="text" size=100 placeholder="type question" value="'+v+'"></div></div>'+F+E+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+
h+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="other-'+c+'" type="checkbox"'+M+'><label>Add \'other field\'</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label class="fleft">Field label</label><input id="other-label-'+c+'" type="text" placeholder="Other (please specify)" value="'+B+'"'+R+'></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="multiple-'+
c+'" type="checkbox"'+S+'><label>Allow multiple responses</label></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label class="fleft">Maximum No. of responses:</label><i class="ucce ucce-minus"> </i> <span id="multiple-count-'+c+'">'+m+'</span> <i class="ucce ucce-plus"> </i></div></div></div>';q='<div class="media content" id="translation-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Multiple choice question</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+
c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+c+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+c+'" type="text" size=100 placeholder="type translated question" value="'+q+'"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row" id="choices-l10n-row-'+
c+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label></div></div>'+n+"</div>";break;case "likert":n=q=v="";M=['<option value="1">Agreement (Disagree - Agree)</option>','<option value="2">Satisfaction (Smiley scale)</option>','<option value="3">Satisfaction (Dissatisfied - Satisfied)</option>','<option value="4">Pain scale (3 point)</option>'];if(e&&(v=u.name,k&&(q=u.name_l10n||""),(m=u.settings)&&m.hasOwnProperty("scale")&&(h=m.scale))){M[h-1]=M[h-1].replace('">',
'" selected>');B=t[h];n+="<ul>";m=0;for(h=B.length;m<h;m++)n+="<li>"+B[m]+"</li>";n+="</ul>"}h=M.join();v='<div class="media content active" id="edit-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Likert-scale</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><input id="name-'+c+'"type="text" size=100 placeholder="type question" value="'+
v+'"></div></div>'+F+E+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Answer</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label>Choices</label><select id="scale-'+c+'"><option value="">Please choose scale</option>'+h+'</select></div></div><div class="row"><div class="columns medium-1"></div><div id="display-'+c+'" class="columns medium-11">'+n+"</div></div></div>";q='<div class="media content" id="translation-'+
b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Likert-scale</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+c+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+c+'" type="text" size=100 placeholder="type translated question" value="'+
q+'"></div></div></div>';break;case "heatmap":L='<div id="choice-row-'+c+'-0" class="row"><a class="button tiny secondary choice-define-'+c+'">Add region 1</a><input class="choice-'+c+'" type="text" placeholder="enter label" disabled><i class="ucce ucce-minus"> </i></div>';q=v="";E=1;h=L;H=n="";if(e){v=u.name;k&&(q=u.name_l10n||"");B=u.options||[];H=u.options_l10n||[];if(G=B.length){h="";for(m=0;m<G;m++)h+='<div id="choice-row-'+c+"-"+m+'" class="row"><a class="button tiny">Add region '+(m+1)+'</a><input class="choice-'+
c+'" type="text" placeholder="enter label" value="'+B[m]+'"><i class="ucce ucce-minus"> </i></div>',K=H[m]||"",K='<div id="choice-l10n-row-'+c+"-"+m+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+c+"-"+m+'" class="translate-from">'+B[m]+'</div></div><div class="columns medium-6"><input class="choice-l10n-'+c+'" type="text" placeholder="Type translation..." value="'+K+'"></div></div></div></div>',
n+=K;h+=L.replace("-0","-"+G).replace("region 1","region "+(G+1))}E=u.settings.numClicks||1}v='<div class="media content active" id="edit-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Heatmap</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-'+c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><input id="name-'+c+'"type="text" size=100 placeholder="type question" value="'+v+'"></div></div>'+
F+'<div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Image</h2></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><label for="image-'+c+'" class="button tiny fleft">Upload image</label><input id="image-'+c+'" name="file" type="file" accept="image/png, image/jpeg" class="show-for-sr"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6 heatmap" id="map-'+
c+'"><span id="preview-'+c+'" class="preview-empty fleft"></span></div><div class="columns medium-6"><div class="row"><h3>Number of clicks allowed:</h3></div><div class="row" id="clicks-row-'+c+'"><i class="ucce ucce-minus"> </i><span> '+E+' </span><i class="ucce ucce-plus"> </i></div><div class="row"><h3>Tap/click regions:</h3></div>'+h+"</div></div></div></div></div>";q='<div class="media content" id="translation-'+b+'"><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="left">Heatmap</h2></div></div><div class="row"><div class="columns medium-1"><label id="qlabel-l10n-'+
c+'" class="fright">Q'+f+'</label></div><div class="columns medium-11"><div id="name-l10n-from-'+c+'" class="translate-from"></div></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><input id="name-l10n-'+c+'" type="text" size=100 placeholder="type translated question" value="'+q+'"></div></div><div class="row"><div class="columns medium-1"></div><div class="columns medium-11"><h2 class="fleft">Answer</h2></div></div><div class="row" id="choices-l10n-row-'+
c+'"><div class="columns medium-1"></div><div class="columns medium-11"><label>Regions</label></div></div>'+n+"</div>"}J=J+v+P+q;J+="</div></div>";a("#survey-droppable-"+b).before(J);f=b+1;a("#survey-droppable-"+b).attr("id","survey-droppable-"+f);r[d]++;a("#section-break-"+w[d]+" > span").html("PAGE "+d+" ("+r[d]+" ELEMENTS)");var z=this.eventNamespace,x=this,Q=function(){a(D).off("change"+z).on("change"+z,function(){var b=this.id.split("-");if("logic"==b[0])b=parseInt(b[b.length-1]),x.logicSelected(a(this),
b);else if("instructions"==p){b=parseInt(b[b.length-1]);var d=x.data.layout[b];d.do.text=a("#do-"+b).val();d.say.text=a("#say-"+b).val();k&&(d.do.hasOwnProperty("10n")||(d.do.l10n={}),d.do.l10n[k]=a("#do-l10n-"+b).val(),d.say.hasOwnProperty("10n")||(d.say.l10n={}),d.say.l10n[k]=a("#say-l10n-"+b).val());x.saveLayout()}else x.saveQuestion(p,c)});if("instructions"!=p&&"heatmap"!=p)a("#pipe-"+c).on("change"+z,function(){var b=a(this).val();if(b){for(var d,e=0,f=g.length;e<f;e++)if(d=g[e],d.label==b){u.settings.pipeImage=
{id:d.id,region:d.region};break}x.deleteImage(c)}else delete u.settings.pipeImage;x.saveQuestion(p,c)})};Q();"instructions"!=p&&(e&&(d=u.file)&&("heatmap"==p?x.heatMap(c,d):l(S3.Ap.concat("/default/download/"+d),function(b){var d=l.scale(b,{canvas:!0,maxHeight:80,maxWidth:80});a("#preview-"+c).removeClass("preview-empty").empty().append(d);return b},{})),a("#image-delete-"+c).on("click"+z,function(){x.deleteImage(c)}),a("#image-"+c).fileupload({dataType:"json",dropZone:a("#preview-"+c+", #image-"+
c),maxNumberOfFiles:1,url:S3.Ap.concat("/dc/question/")+c+"/image_upload.json",add:function(b,d){if(b.isDefaultPrevented())return!1;(d.autoUpload||!1!==d.autoUpload&&a(this).fileupload("option","autoUpload"))&&d.process().done(function(){d.submit();if("heatmap"==p)x.heatMap(c,b);else{var b=d.files[0];l(b,function(b){var d=l.scale(b,{canvas:!0,maxHeight:80,maxWidth:80});a("#preview-"+c).removeClass("preview-empty").empty().append(d);u.settings.hasOwnProperty("pipeImage")&&a("#pipe-"+c).val("").trigger("change");
d=!1;for(b in g)b.id==c&&(d=!0);d||(d="Q"+a("#question-"+c).data("number")+" "+p,g.push({label:d,id:c}));d=x.data.questions;for(var e=x.data.layout,f=1;f<=Object.keys(e).length;f++){var h=e[f];if("question"==h.type){h=h.id;var k=d[h];13!=k.type&&a("#pipe-"+h).empty().append(x.pipeOptionsHtml(h))}}return b},{})}})}}));a(N).on("click"+z,function(){x.deleteQuestion(p,c,this)});switch(p){case "number":a("#answer-"+c).validate({rules:{min:{required:!1,digits:!0,lessThanMax:!0},max:{required:!1,digits:!0,
greaterThanMin:!0}},messages:{min:{digits:"Only integers allowed"},max:{digits:"Only integers allowed"}},errorClass:"req",focusCleanup:!0});break;case "multichoice":var I=a("#multiple-"+c),C=a("#multiple-count-"+c),O=function(){var b=a(".choice-"+c).next();b.off("click"+z).on("click"+z,function(){if(1<a(".choice-"+c).length){var b=a(this).closest(".row"),d=parseInt(b.attr("id").split("-")[3]);b.remove();a("#choice-l10n-row-"+c+"-"+d).remove();b=a(".choice-"+c).length;for(var e=d+1;e<=b;e++)d=e-1,
a("#choice-row-"+c+"-"+e).attr("id","choice-row-"+c+"-"+d),a("#choice-l10n-row-"+c+"-"+e).attr("id","choice-l10n-row-"+c+"-"+d),a("#choice-from-"+c+"-"+e).attr("id","choice-from-"+c+"-"+d);d=parseInt(C.html());a("#other-"+c).prop("checked")&&b++;d>b&&(C.html(b),1==b&&I.prop("checked",!1));x.saveQuestion(p,c)}else a(this).prev().val("")});b.next().off("click"+z).on("click"+z,function(){for(var b=a(this).closest(".row"),d=parseInt(b.attr("id").split("-")[3]),e,f=a(".choice-"+c).length-1;f>d;f--)e=f+
1,a("#choice-row-"+c+"-"+f).attr("id","choice-row-"+c+"-"+e),a("#choice-l10n-row-"+c+"-"+f).attr("id","choice-l10n-row-"+c+"-"+e),a("#choice-from-"+c+"-"+f).attr("id","choice-from-"+c+"-"+e);e=d+1;b.after(L.replace("-0","-"+e));b='<div id="choice-l10n-row-'+c+"-"+e+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+c+"-"+e+'" class="translate-from"></div></div><div class="columns medium-6"><input class="choice-l10n-'+
c+'" type="text" placeholder="Type translation..."></div></div></div></div>';a("#choice-l10n-row-"+c+"-"+d).after(b);Q();O()});a("#other-"+c).on("change"+z,function(){if(a(this).prop("checked"))a("#other-label-"+c).prop("disabled",!1),a("#other-l10n-row-"+c).removeClass("hide").show();else{a("#other-label-"+c).prop("disabled",!0);a("#other-l10n-row-"+c).hide();var b=parseInt(C.html()),d=a(".choice-"+c).length;b>d&&(C.html(d),1==d&&I.prop("checked",!1))}});I.on("change"+z,function(){if(I.prop("checked")){parseInt(C.html());
var b=a(".choice-"+c).length;a("#other-"+c).prop("checked")&&b++;1<b?C.html(2):I.prop("checked",!1)}else C.html(1);x.saveQuestion(p,c)});C.prev().on("click"+z,function(){if(I.prop("checked")){var a=parseInt(C.html());2<a?(C.html(a-1),x.saveQuestion(p,c)):2==a&&(C.html(1),I.prop("checked",!1),x.saveQuestion(p,c))}});C.next().on("click"+z,function(){if(I.prop("checked")){var b=parseInt(C.html()),d=a(".choice-"+c).length;a("#other-"+c).prop("checked")&&d++;b<d&&(C.html(b+1),x.saveQuestion(p,c))}})};
O();break;case "likert":a("#scale-"+c).on("change"+z,function(){var b=a(this).val();if(b){b=t[b];for(var d="",e=0,f=b.length;e<f;e++)d+="<li>"+b[e]+"</li>";b="<ul>"+d+"</ul>";a("#display-"+c).empty().append(b)}else a("#display-"+c).empty()});break;case "heatmap":O=function(){a(".choice-"+c).next().off("click"+z).on("click"+z,function(){if(1<a(".choice-"+c).length){var b=a(this).closest(".row"),d=parseInt(b.attr("id").split("-")[3]);b.remove();a("#choice-l10n-row-"+c+"-"+d).remove();b=a(".choice-"+
c).length;for(var e=d+1;e<=b;e++)d=e-1,a("#choice-row-"+c+"-"+e).attr("id","choice-row-"+c+"-"+d),a("#choice-row-"+c+"-"+d+" > .button").html("Add region "+(d+1)),a("#choice-l10n-row-"+c+"-"+e).attr("id","choice-l10n-row-"+c+"-"+d),a("#choice-from-"+c+"-"+e).attr("id","choice-from-"+c+"-"+d);x.saveQuestion(p,c)}else b=a(this).prev(),b.val("").prop("disabled",!0),b.prev().addClass("secondary")});a(".choice-define-"+c).off("click"+z).on("click"+z,function(){var b=a(this),d=b.closest(".row"),e=parseInt(d.attr("id").split("-")[3]);
if(b.hasClass("secondary")){var f=e+1;d.after(L.replace("-0","-"+f));a("#choice-row-"+c+"-"+f+" > .button").html("Add region "+(f+1));d='<div id="choice-l10n-row-'+c+"-"+e+'" class="row"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-6"><div id="choice-from-'+c+"-"+e+'" class="translate-from"></div></div><div class="columns medium-6"><input class="choice-l10n-'+c+'" type="text" placeholder="Type translation..."></div></div></div></div>';
0==e?a("#choices-l10n-row-"+c).after(d):a("#choice-l10n-row-"+c+"-"+(e-1)).after(d);Q();O()}b.removeClass("secondary");b.next().prop("disabled",!1)})},O(),d=a("#clicks-row-"+c).children().first(),d.off("click"+z).on("click"+z,function(){var b=a(this),d=parseInt(b.next().html());1<d&&(d--,x.data.questions[c].settings.numClicks=d,x.saveQuestion(p,c),b.next().html(" "+d+" "))}),d.next().next().off("click"+z).on("click"+z,function(){var b=a(this).prev(),d=parseInt(b.html());d++;x.data.questions[c].settings.numClicks=
d;x.saveQuestion(p,c);b.html(" "+d+" ")})}"instructions"==p?a("#instruction-"+b).foundation("tab","reflow"):a("#question-"+c).foundation("tab","reflow")},deleteQuestion:function(b,d,p){if("instructions"==b){p=parseInt(a(p).closest(".dl-item").attr("id").split("-")[1]);var c=a("#instruction-"+p).data("page")}else{var e=a("#question-"+d).data("number");p=A[e];c=a("#question-"+d).data("page")}r[c]--;a("#section-break-"+w[c]+" > span").html("PAGE "+c+" ("+r[c]+" ELEMENTS)");var k=c+1;for(c=Object.keys(w).length;k<=
c;k++)w[k]--;c=e;var m,h,f=this.data.layout,g=Object.keys(f).length;for(k=p;k<g;k++){e=k+1;var q=f[e];f[k]=q;if("break"==q.type)a("#section-break-"+e).attr("id","section-break-"+k);else{if("question"==q.type){var n=q.id;q=a("#question-"+n);c=q.data("number");if("instructions"==b)A[c]=k;else{var l=c-1;q.data("number",l);a("#qlabel-"+n).html("Q"+l);a("#qlabel-l10n-"+n).html("Q"+l);A[l]=k}}else a("#instruction-"+e).attr("id","instruction-"+k),q=a("#instruction-"+k),a("#do-"+e).attr("id","do-"+k),a("#say-"+
e).attr("id","say-"+k),a("#do-l10n-"+e).attr("id","do-l10n-"+k),a("#say-l10n-"+e).attr("id","say-l10n-"+k);a("#edit-"+e).attr("id","edit-"+k);a("#logic-"+e).attr("id","logic-"+k);a("#translation-"+e).attr("id","translation-"+k);q.find("li.tab-title > a").each(function(){var b=a(this);m=b.attr("href");h=m.split("-")[0];h=h.substring(1,h.length);b.attr("href","#"+h+"-"+k)})}}delete f[g];"instructions"!=b&&delete A[c];this.saveLayout();"instructions"==b?a("#instruction-"+p).remove():a("#question-"+d).remove();
a("#survey-droppable-"+(g+1)).attr("id","survey-droppable-"+g);"instructions"!=b&&(b=S3.Ap.concat("/dc/question/")+d+"/delete.json",this.ajaxMethod({url:b,type:"POST",dataType:"json",success:function(){},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}}))},heatMap:function(b,d){var p=S3.Ap.concat("/default/download/"+d);a("<img>").attr("src",p).load(function(){var c=this.width,d=this.height;a("#map-"+b).empty();d=[0,0,c,d];var k=new Projection({code:"preview-image",
units:"pixels",extent:d}),m=new ImageLayer({source:new Static({url:p,projection:k,imageExtent:d})});c=new VectorSource({wrapX:!1});var h=new VectorLayer({source:c});d=new Map({controls:[],interactions:[],layers:[m,h],target:"map-"+b,view:new View({projection:k,center:getCenter(d),zoom:1,maxZoom:1})});c=new Draw({source:c,type:"Polygon"});d.addInteraction(c)})},pipeOptionsHtml:function(a){var b=this.data.questions[a];var p='<option value="">select question</option>';if(b&&b.settings&&b.settings.pipeImage)var c=
b.settings.pipeImage;for(var e=0,k=g.length;e<k;e++)b=g[e],b.id!=a&&(p=c&&c.id==b.id&&c.region==b.region?p+("<option selected>"+b.label+"</option>"):p+("<option>"+b.label+"</option>"));return p},logicOptionsHtml:function(a,d){var b='<option value="">select question</option>',c=this.data.questions,e=this.data.layout;d=e[d].displayLogic;if(d)var k=d.id;d=1;for(var m=Object.keys(A).length;d<=m;d++){var h=A[d];h=e[h].id;if(h!=a){var f=c[h];var g=D[f.type];if("number"==g||"multichoice"==g||"likert"==g||
"heatmap"==g)g="Q"+d+": ",f=f.name||"",f=53<f.length?f.substring(0,50)+"...":f,g+=f,f=h==k?" selected":"",b+='<option value="'+h+'"'+f+">"+g+"</option>"}}return b},logicSubOptions:function(b,d){var p=this.eventNamespace,c=this,e=this.data.layout[b].displayLogic,k=this.data.questions[d],m=D[k.type];if("number"==m){var h="",f="";if(e){h=e.eq||"";var g=e.gt;var q=e.lt;h?f=h:q?f=q:g&&(f=g)}k='<select id="logic-operator-1-'+b+'">';k=!e||h?k+'<option value="eq" selected>equal to ( = )</option>':k+'<option value="eq">equal to ( = )</option>';
q?k+='<option value="lt" selected>less than ( &lt; )</option><option value="gt">more than ( &gt; )</option>':(k+='<option value="lt">less than ( &lt; )</option>',k=g?k+'<option value="gt" selected>more than ( &gt; )</option>':k+'<option value="gt">more than ( &gt; )</option>');k+='</select><input id="logic-term-1-'+b+'" type="number" placeholder="type number" value="'+f+'">';a("#logic-response-"+b).html(k);h||!q&&!g?(f="",h=" hide"):(h="",f=q&&g?g:"");h='<div class="row'+h+'"><div class="columns medium-1"></div><div class="columns medium-11"><div class="row"><div class="columns medium-2"><label class="fleft">AND</label></div><div class="columns medium-10"><select id="logic-operator-2-'+
b+'">'+(!q&&g?'<option value="lt" selected>less than ( &lt; )</option><option value="gt">more than ( &gt; )</option>':'<option value="lt">less than ( &lt; )</option><option value="gt" selected>more than ( &gt; )</option>')+'</select><input id="logic-term-2-'+b+'" type="number" placeholder="type number" value="'+f+'"></div></div></div></div>';var n=a("#logic-response-row-"+b);n.after(h);var l,r=a("#logic-operator-1-"+b),t=a("#logic-operator-2-"+b),w=a("#logic-term-1-"+b),u=a("#logic-term-2-"+b);r.on("change"+
p,function(){l=a(this).val();f=w.val();e={id:d};if("eq"==l)n.next().hide(),f&&(e.eq=f);else if("gt"==l){if(n.next().removeClass("hide").show(),t.val("lt"),f&&(e.gt=f),f=u.val())e.lt=f}else"lt"==l&&(n.next().removeClass("hide").show(),t.val("gt"),f&&(e.lt=f),f=u.val())&&(e.gt=f);c.data.layout[b].displayLogic=e;c.saveLayout()});t.on("change"+p,function(){l=a(this).val();f=u.val();e={id:d};if("gt"==l){if(r.val("lt"),f&&(e.gt=f),f=w.val())e.lt=f}else"lt"==l&&(r.val("gt"),f&&(e.lt=f),f=w.val())&&(e.gt=
f);c.data.layout[b].displayLogic=e;c.saveLayout()});w.on("change"+p,function(){if(f=a(this).val()){e={id:d};l=r.val();if("eq"==l)e.eq=f;else if("gt"==l?e.gt=f:e.lt=f,f=u.val())l=t.val(),"gt"==l?e.gt=f:e.lt=f;c.data.layout[b].displayLogic=e}else(f=u.val())?(e={id:d},l=r.val(),"gt"==l?e.gt=f:e.lt=f,c.data.layout[b].displayLogic=e):delete c.data.layout[b].displayLogic;c.saveLayout()});u.on("change"+p,function(){if(f=a(this).val()){e={id:d};l=t.val();"gt"==l?e.gt=f:e.lt=f;if(f=w.val())l=r.val(),"gt"==
l?e.gt=f:e.lt=f;c.data.layout[b].displayLogic=e}else(f=w.val())?(e={id:d},l=r.val(),"eq"==l?e.eq=f:"gt"==l?e.gt=f:e.lt=f,c.data.layout[b].displayLogic=e):delete c.data.layout[b].displayLogic;c.saveLayout()})}else{q=k.options;g='<select id="sub-logic-select-'+b+'"><option value="">select '+("heatmap"==m?"region":"option")+"</option>";e&&(h=e.option);for(var y=0,v=q.length;y<v;y++){option=q[y];var A=option==h?" selected":"";g+='<option value="'+option+'"'+A+">"+option+"</option>"}"multichoice"==m&&
(k=k.settings.other)&&(g+='<option value="_other"'+("_other"==h?" selected":"")+">"+k+"</option>");g+="</select>";a("#logic-response-"+b).html(g);a("#sub-logic-select-"+b).on("change"+p,function(){c.data.layout[b].displayLogic={id:d,option:a(this).val()};c.saveLayout()})}},logicSelected:function(b,d){b=b.val();a("#logic-response-"+d).empty();a("#logic-response-row-"+d).next().remove();b?this.logicSubOptions(d,b):(delete this.data.layout[d].displayLogic,this.saveLayout())},deleteImage:function(b){var d=
this,p=a("#preview-"+b);if(!p.hasClass("preview-empty")){var c=S3.Ap.concat("/dc/question/")+b+"/image_delete.json";this.ajaxMethod({url:c,type:"POST",dataType:"json",success:function(){p.empty().addClass("preview-empty");var c=g;g=[];for(var k=0,m=c.length;k<m;k++){var h=c[k];h.id!=b&&g.push(h)}h=d.data.questions;c=d.data.layout;for(k=1;k<=Object.keys(c).length;k++)if(m=c[k],"question"==m.type){m=m.id;var f=h[m];13!=f.type&&a("#pipe-"+m).empty().append(d.pipeOptionsHtml(m))}},error:function(a,b,
c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}},addSectionBreak:function(b,d,g){d++;w[d]=b;r[d]=0;var c='<div class="row"><div class="section-break medium-11 columns" id="section-break-'+b+'" data-page="'+d+'"><span>PAGE '+d+' (0 ELEMENTS)</span></div><div class="medium-1 columns">'+(b?'<i class="ucce ucce-delete-page"> </i>':"")+'<i class="ucce ucce-down-alt"> </i></div></div>';if(b){a("#survey-droppable-"+b).before(c);c=b+1;a("#survey-droppable-"+b).data("page",d).attr("id",
"survey-droppable-"+c);g||(this.data.layout[b]={type:"break"},this.saveLayout());var e=this;d=this.eventNamespace;a("#section-break-"+b).next().children(".ucce-delete-page").on("click"+d,function(){var b=parseInt(a(this).parent().prev().attr("id").split("-")[2]);e.deleteSectionBreak(b)})}else a(this.element).parent().append(c)},deleteSectionBreak:function(b){var d=a("#section-break-"+b).data("page"),g=r[d];if(g){var c=d-1;r[c]+=g;a("#section-break-"+w[c]+" > span").html("PAGE "+c+" ("+r[c]+" ELEMENTS)")}g=
Object.keys(w).length;for(var e=d;e<g;e++)w[e]=w[e+1]-1,r[e]=r[e+1];delete w[g];delete r[g];d=this.data.layout;c=Object.keys(d).length;if(b!=c){var k,m;for(e=b;e<c;e++){var h=e+1;var f=d[h];d[e]=f;if("break"==f.type)f=a("#section-break-"+h).data("page")-1,a("#section-break-"+h).data("page",f),a("#section-break-"+h+" > span").html("PAGE "+f+" ("+r[f]+" ELEMENTS)"),a("#section-break-"+h).attr("id","section-break-"+e);else{if("question"==f.type){var l=a("#question-"+f.id);f=l.data("number");A[f]=e}else a("#instruction-"+
h).attr("id","instruction-"+e),l=a("#instruction-"+e),a("#do-"+h).attr("id","do-"+e),a("#say-"+h).attr("id","say-"+e),a("#do-l10n-"+h).attr("id","do-"+e),a("#say-l10n-"+h).attr("id","say-"+e);a("#edit-"+h).attr("id","edit-"+e);a("#logic-"+h).attr("id","logic-"+e);a("#translation-"+h).attr("id","translation-"+e);l.find("li.tab-title > a").each(function(){var b=a(this);k=b.attr("href");m=k.split("-")[0];m=m.substring(1,m.length);b.attr("href","#"+m+"-"+e)})}}}delete d[c];this.saveLayout();a("#section-break-"+
b).parent().remove();a("#survey-droppable-"+(c+1)).data("page",g-1).attr("id","survey-droppable-"+c)},droppable:function(b,d){var g=this;d='<div class="survey-droppable" id="survey-droppable-'+b+'" data-page="'+d+'"><span>Drag and drop questions here</span></div>';a(this.element).parent().append(d);a("#survey-droppable-"+b).droppable({drop:function(b,d){b=d.draggable[0].id;d=parseInt(this.id.split("-")[2]);var c=a(this).data("page");"break"==b?g.addSectionBreak(d,c):g.addQuestion(d,c,b)}})},_destroy:function(){a.Widget.prototype.destroy.call(this)},
loadSurvey:function(){var a=this.data.layout;if(a){for(var d,p=1,c=0,e,k,m=this.data.questions,h=Object.keys(a).length,f=1;f<=h;f++)if(d=a[f],"break"!=d.type&&"instructions"!=d.type&&(c++,A[c]=f,d=d.id,e=m[d],e.file))if(13==e.type){var l=e.settings.regions;if(l){e="Q"+c+" Heatmap; ";for(var n=0,r=l.length;n<r;n++)k=e+"'"+l[n].label+"'",g.push({label:k,id:d,region:n})}}else k="Q"+c+" "+D[e.type],g.push({label:k,id:d});for(f=1;f<=h;f++)d=a[f],"break"==d.type?(this.addSectionBreak(f,p,!0),p++):"instructions"==
d.type?this.addQuestion(f,p,"instructions",!0):(d=d.id,this.addQuestion(f,p,D[m[d].type],d))}},refresh:function(){this._unbindEvents();this._deserialize();this.addSectionBreak(0,0);this.droppable(1,1);this.loadSurvey();this._bindEvents()},saveQuestion:function(b,d){var g=a("#name-"+d).val();if(g){var c=S3.Ap.concat("/dc/question/")+d+"/update_json.json",e=a("#mandatory-"+d).prop("checked"),k={name:g,mandatory:e},m=this.data.l10n,h={},f=this.data.questions[d];f.name=g;f.mandatory=e;m&&(g=a("#name-l10n-"+
d).val())&&(k.name_l10n=g,f.name_l10n=g);if(g=f.settings.pipeImage)h.pipeImage=g;switch(b){case "number":a("#min-"+d).hasClass("req")?b=null:(b=a("#min-"+d).val())&&(b=parseInt(b));a("#max-"+d).hasClass("req")?d=null:(d=a("#max-"+d).val())&&(d=parseInt(d));h.requires={isIntInRange:{min:b,max:d}};break;case "multichoice":var l=[];a(".choice-"+d).each(function(){l.push(a(this).val())});k.options=l;f.options=l;if(m){var n=[];a(".choice-l10n-"+d).each(function(){n.push(a(this).val())});k.options_l10n=
n}a("#other-"+d).prop("checked")?(h.other=a("#other-label-"+d).val(),m&&(h.otherL10n=a("#other-l10n-"+d).val())):(h.other=null,m&&(h.otherL10n=null));a("#multiple-"+d).prop("checked")?h.multiple=parseInt(a("#multiple-count-"+d).html()):h.multiple=1;break;case "likert":(d=a("#scale-"+d).val())?(l=t[d],h.scale=d):(l=[],h.scale=null);k.options=l;f.options=l;break;case "heatmap":if(l=[],a(".choice-"+d).each(function(){l.push(a(this).val())}),l.pop(),k.options=l,f.options=l,m&&(n=[],a(".choice-l10n-"+
d).each(function(){n.push(a(this).val())}),k.options_l10n=n),d=f.settings.numClicks)h.numClicks=d}k.settings=h;f.settings=h;this.ajaxMethod({url:c,type:"POST",data:JSON.stringify(k),dataType:"json",success:function(){},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}},saveLayout:function(){var a=S3.Ap.concat("/dc/template/")+this.recordID+"/update_json.json";this.ajaxMethod({url:a,type:"POST",data:JSON.stringify({layout:this.data.layout}),dataType:"json",
success:function(){},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})},_deserialize:function(){var b=a(this.element).val()||"{}";return this.data=JSON.parse(b)},_bindEvents:function(){var b=this,d=this.eventNamespace,g=a("#survey-name");a(document).foundation({tab:{callback:function(c){var d=c.text();if("Display logic"==d){d=c.children().first().attr("href").split("-")[1];var g=a("#logic-select-"+d);c=c.closest(".dl-item").attr("id").split("-");var m=
c[0];if("instruction"==m)g.html(b.logicOptionsHtml(null,d));else{var h=c[1];g.html(b.logicOptionsHtml(h,d))}b.logicSelected(g,d)}else if("Translation"==d)if(d=c.children().first().attr("href").split("-")[1],c=c.closest(".dl-item").attr("id").split("-"),m=c[0],"instruction"==m)a("#do-l10n-"+d).prev().html(a("#do-"+d).val()),a("#say-l10n-"+d).prev().html(a("#say-"+d).val());else switch(h=c[1],d=b.data.questions[h],a("#name-l10n-from-"+h).html(a("#name-"+h).val()),m=D[d.type],m){case "multichoice":a(".choice-"+
h).each(function(b){a("#choice-from-"+h+"-"+b).html(a(this).val())});a("#other-l10n-from-"+h).html(a("#other-label-"+h).val());break;case "heatmap":a(".choice-"+h).each(function(b){a("#choice-from-"+h+"-"+b).html(a(this).val())})}}}});g.on("change"+d,function(){var a=g.val(),d=g.data("id");b.ajaxMethod({url:S3.Ap.concat("/dc/target/")+d+"/name.json",type:"POST",data:JSON.stringify({name:a}),dataType:"json",success:function(){},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:
a.responseText)}})});a("#survey-l10n").on("change"+d,function(){var c=a(this).val(),d=g.data("id");b.ajaxMethod({url:S3.Ap.concat("/dc/target/")+d+"/l10n.json",type:"POST",data:JSON.stringify({l10n:c}),dataType:"json",success:function(){(b.data.l10n=c)?(a("li.l10n").removeClass("hide").show(),a(document).foundation("tab","reflow")):a("li.l10n").hide()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})});a(".draggable").draggable({revert:!0,revertDuration:250})},
_unbindEvents:function(){var b=this.eventNamespace;a("#survey-name").unbind(b);a("#survey-l10n").unbind(b);b=a(".draggable");void 0!=b.draggable("instance")&&b.draggable("destroy");return!0}})});
