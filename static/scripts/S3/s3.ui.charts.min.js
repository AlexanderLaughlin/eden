/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(f,m){var l=0;f.widget("s3.uiChart",{options:{height:"280px",colors:null,transition:50,staggerLabels:!0,valueFormat:",.0f"},_create:function(){this.id=l;l+=1;this.eventNamespace=".uiChart"},_init:function(){this.refresh()},_destroy:function(){f.Widget.prototype.destroy.call(this)},refresh:function(){var d=f(this.element),a=this.options;this._unbindEvents();d.empty().css({height:a.height});a=d3.select(d.get(0)).append("svg").attr("class","nv");switch(d.data("type")){case "piechart":this._pieChart(a);
break;case "barchart":this._barChart(a);break;case "multibarchart":this._multiBarChart(a)}this._bindEvents()},_getData:function(d){var a=f(this.element).data("source");a&&f.ajaxS3({url:a,dataType:"json",type:"GET",ignoreStatus:[404],success:function(b){d(b)},error:function(b,c,a){d([]);console.log("UNAUTHORIZED"==a?i18n.gis_requires_login:b.responseText)}})},_barChart:function(d){var a=f(this.element),b=this.options,c=nv.models.discreteBarChart().duration(b.transition).x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(b.staggerLabels).showValues(!0),
e=d3.format(b.valueFormat);c.yAxis.tickFormat(e);c.valueFormat(e);b.colors&&c.color(b.colors);var k=a.data("url"),g=a.data("items"),h=this;nv.addGraph(function(){h._getData(function(a){d.datum(a).call(c);c.update();nv.utils.windowResize(c.update);if(k&&g)c.discretebar.dispatch.on("elementClick",function(a){var b={};b[g]=a.data.filterKey;a=h._updateURL(k,b);window.open(a,"_blank")})})});return c},_multiBarChart:function(d){var a=f(this.element),b=this.options,c=nv.models.multiBarChart().duration(b.transition).x(function(a){return a.label}).y(function(a){return a.value}).reduceXTicks(!1).staggerLabels(b.staggerLabels).stacked(!0).groupSpacing(.1),
e=d3.format(b.valueFormat);c.yAxis.tickFormat(e);"off"==a.data("controls")&&c.showControls(!1);"off"==a.data("legend")&&c.showLegend(!1);b.colors&&c.color(b.colors);var k=a.data("url"),g=a.data("items"),h=this;nv.addGraph(function(){h._getData(function(b){d.datum(b).call(c);c.update();nv.utils.windowResize(c.update);if(k&&g){var e=a.data("series");c.multibar.dispatch.on("elementClick",function(a){var b={};b[g]=a.data.filterKey;e&&(b[e]=a.element.parentElement.__data__.filterKey);a=h._updateURL(k,
b);window.open(a,"_blank")})}})});return c},_updateURL:function(d,a){var b=document.createElement("a");b.href=d;d=[];for(var c in a)d.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));d.length&&(b.search=b.search?b.search+d.join("&"):"?"+d.join("&"));return b.href},_pieChart:function(d){var a=f(this.element),b=this.options,c="off"==a.data("legend"),e=nv.models.pieChart().duration(b.transition).x(function(a){return a.label}).y(function(a){return a.value}).showLabels(c).showTooltipPercent(!0),
k=d3.format(b.valueFormat);e.valueFormat(k);c&&e.showLegend(!1);b.colors&&e.color(b.colors);var g=a.data("url"),h=a.data("items"),l=this;nv.addGraph(function(){l._getData(function(a){d.datum(a).call(e);e.update();nv.utils.windowResize(e.update);if(g&&h)e.pie.dispatch.on("elementClick",function(a){var b={};b[h]=a.data.filterKey;a=l._updateURL(g,b);window.open(a,"_blank")})})});return e},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
