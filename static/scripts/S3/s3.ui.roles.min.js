/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,g,e){a!=Array.prototype&&a!=Object.prototype&&(a[g]=e.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(g){return $jscomp.SYMBOL_PREFIX+(g||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.arrayIterator=function(a){var g=0;return $jscomp.iteratorPrototype(function(){return g<a.length?{done:!1,value:a[g++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,g){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var e=0,h={next:function(){if(e<a.length){var b=e++;return{value:g(b,a[b]),done:!1}}h.next=function(){return{done:!0,value:void 0}};return h.next()}};h[Symbol.iterator]=function(){return h};return h};
$jscomp.polyfill=function(a,g,e,h){if(g){e=$jscomp.global;a=a.split(".");for(h=0;h<a.length-1;h++){var b=a[h];b in e||(e[b]={});e=e[b]}a=a[a.length-1];h=e[a];g=g(h);g!=h&&null!=g&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
(function(a,g){var e={rm_Add:"Add",rm_Cancel:"Cancel",rm_ConfirmDeleteAssignment:"Do you want to remove this assignment?",rm_Delete:"Delete",rm_DeletionFailed:"Deletion Failed",rm_ForEntity:"For Entity",rm_Roles:"Roles",rm_SubmissionFailed:"Submission Failed",rm_Users:"Users"},h=0;a.widget("s3.roleManager",{options:{mode:"roles",items:{},useRealms:!1,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=h;h+=1;this.eventNamespace=".roleManager"},_init:function(){for(var a in e)e[a]=
i18n[a]||e[a];this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var b=a(this.element);this._unbindEvents();a(".rm-assign",b).remove();this.itemSelector=this.realmSelector=this.addButton=this.addRow=null;this._deserialize();b.append(this._assignmentTable());this._bindEvents()},_deserialize:function(){var b=a(this.element).attr("id"),c=a("#"+b+"-data").val();try{this.assignments=JSON.parse(c)}catch(d){this.assignments=[]}this.recordID=a("#"+b+"-id").val()},
_serialize:function(){var b=a(this.element).attr("id");a("#"+b+"-data").val(JSON.stringify(this.assignments))},_assignmentTable:function(){var b=this.options,c=a('<table class="rm-assign">');c.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(b.ajaxURL){b=b.items;var d=!1,f;for(f in b)if(!1!==b[f].a){d=!0;break}d&&c.append(this._assignmentTableFooter())}return c},_assignmentTableHead:function(){var b=this.options,c=a("<thead>"),d=a("<tr>").appendTo(c);var f="users"==b.mode?
e.rm_Users:e.rm_Roles;a("<th>").text(f).appendTo(d);b.useRealms&&a("<th>").text(e.rm_ForEntity).appendTo(d);a("<th>").appendTo(d);return c},_assignmentTableBody:function(){var b=a("<tbody>"),c=this;this.assignments.sort(function(a,b){return c._compareAssignments(a,b)}).forEach(function(a){b.append(c._assignmentTableRow(a))});return b},_assignmentTableRow:function(b){var c=a('<tr class="rm-assignment">').data("assignment",b),d=this.options,f=d.items[b[0]],g=a("<td>").appendTo(c);a('<span class="rm-item-name">').text(f.l).appendTo(g);
f.t&&a('<span class="rm-item-title">').text(f.t).appendTo(g);d.useRealms&&(b=!f.u&&d.realms[b[1]].l||"",a("<td>").text(b).appendTo(c));b=a("<td>");!1!==f.r&&d.ajaxURL&&(d=a('<span class="rm-delete-assignment delete-btn-ajax">'),b.append(d.text(e.rm_Delete)));return c.append(b)},_assignmentTableFooter:function(){var b=a("<tfoot>"),c=a("<tr>").appendTo(b);a("<td>").append(this._itemSelector()).appendTo(c);this.options.useRealms&&a("<td>").append(this._realmSelector()).appendTo(c);var d=a('<a class="rm-submit-add action-btn">').text(e.rm_Add),
f=a('<span class="rm-cancel-add action-lnk">').text(e.rm_Cancel);d.prop("disabled",!0).attr("disabled","disabled");a('<td class="rm-row-actions">').append(d).append(f).appendTo(c);this.addRow=c;return b},_itemSelector:function(){var b=a('<select class="rm-item-select">'),c=this.options.items,d=[];a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);var f;for(f in c){var g=c[f];if(!1!==g.a){var e=g.l;g.t&&(e+=" ("+g.t+")");d.push([f,e])}}d.sort(function(a,b){return a[1]>
b[1]&&1||-1}).forEach(function(c){a("<option>").attr("value",c[0]).text(c[1]).appendTo(b)});return this.itemSelector=b},_realmSelector:function(){var b=a('<select class="rm-realm-select">'),c=this.options,d=c.realms,f=this,e={};Object.keys(d).sort(function(a,b){return f._compareRealms(a,b)}).forEach(function(a){var b=d[a],c=b.t;a=[a,b.l];b=e[c];b===g?e[c]=[a]:b.push(a)});a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);c.realmTypes.forEach(function(c){var d=e[c[0]];
if(d){var f=a("<optgroup>").attr("label",c[1]).appendTo(b);d.forEach(function(b){a("<option>").attr("value",b[0]).text(b[1]).appendTo(f)})}});this.realmSelector=b;this._resetRealmSelector();return b.prop("disabled",!0).css({visibility:"hidden"})},_toggleAdd:function(b){var c=a(".rm-submit-add",this.addRow);c.length&&(b?c.prop("disabled",!1).removeAttr("disabled"):c.prop("disabled",!0).attr("disabled","disabled"))},_resetAddRow:function(){var b=a(".rm-item-select",this.addRow);b.length&&b.val("").change();
this._checkNewAssignment()},_resetRealmSelector:function(){var b=this.realmSelector;b!==g&&(a('option[value="null"]',b).length?b.val("null"):b.val(""))},_optionSelected:function(){var a=this.options,c=this.itemSelector,d=this.realmSelector;if(c!==g)if(c=c.val()){if(a=a.items[c])d!==g&&(a.u?(this._resetRealmSelector(),d.prop("disabled",!0).css({visibility:"hidden"})):d.prop("disabled",!1).css({visibility:"visible"})),!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)}else d!==
g&&(this._resetRealmSelector(),d.prop("disabled",!0).css({visibility:"hidden"})),this._toggleAdd(!1)},_realmSelected:function(){!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)},_getNewAssignment:function(){var a=this.itemSelector;if(a){var c=null;if((a=a.val())&&!isNaN(a-0))return this.options.useRealms&&(c=this.realmSelector.val(),null!==c&&(c-=0,isNaN(c)&&(c=null))),[a-0,c]}},_checkNewAssignment:function(){var b=this._getNewAssignment(),c=a(".rm-assignment",a(this.element)).removeClass("rm-duplicate");
if(b){for(var d=c.length;d--;){var f=a(c[d]),e=f.data("assignment");if(b[0]===e[0]&&b[1]===e[1])return f.addClass("rm-duplicate"),!1}return b}},_addAssignment:function(){var b=this.options.ajaxURL,c=this._checkNewAssignment();if(b&&c){var d=this.addRow,f=a(".rm-submit-add",d).hide(),g=a(".rm-cancel-add",d).hide(),h=a('<div class="inline-throbber">').insertBefore(f),k=this;a.ajaxS3({type:"POST",url:b.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[c]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",
success:function(){k.assignments.push(c);k._serialize();for(var b=a(".rm-assignment",a(k.element)),e=k._assignmentTableRow(c).hide(),m=b.length;m--;){var n=a(b[m]),p=n.data("assignment");if(-1==k._compareAssignments(p,c)){e.insertAfter(n).fadeIn();e=null;break}}e&&(a("tbody",d.closest(".rm-assign")).prepend(e),e.fadeIn());h.remove();f.show();g.show();k._resetAddRow()},error:function(){var b=a('<span class="rm-error">').insertBefore(h.hide());b.text(e.rm_SubmissionFailed);h.remove();window.setTimeout(function(){b.fadeOut(function(){f.show();
g.show()})},1E3)}})}},_deleteAssignment:function(b){var c=this.options,d=c.ajaxURL,f=b.data("assignment");if(d&&f){var g=e.rm_ConfirmDeleteAssignment;g=g.replace(/%\((role|user)\)s/g,'"'+c.items[f[0]].l+'"');if(confirm(g)){var h=a(".rm-delete-assignment",b).hide(),k=a('<div class="inline-throbber">').insertBefore(h),l=this;a.ajaxS3({type:"POST",url:d.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[f]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){l.assignments=
l.assignments.filter(function(a){return a[0]!==f[0]||a[1]!==f[1]});l._serialize();a(".rm-assignment",a(l.element)).each(function(){var b=a(this).data("assignment");b[0]===f[0]&&b[1]===f[1]&&a(this).fadeOut(function(){k.remove();a(this).remove()})});l._checkNewAssignment()&&l._toggleAdd(!0)},error:function(){var b=a('<span class="rm-error">').insertBefore(k.hide());b.text(e.rm_DeletionFailed);k.remove();window.setTimeout(function(){b.fadeOut(function(){h.show()})},1E3)}})}}},_compareAssignments:function(a,
c){var b=this.options.items,f=b[a[0]].l;b=b[c[0]].l;return f==b?this._compareRealms(a[1],c[1]):f>b&&1||-1},_compareRealms:function(a,c){if(a===c)return 0;var b=this.options.realms,f=this._compareRealmTypes(b[a].t,b[c].t);return f?f:a?c?b[a].l>b[c].l&&1||-1:-1:null===a&&1||null===c&&-1||1},_compareRealmTypes:function(a,c){if(a===c)return 0;var b=this.options.realmTypes.map(function(a){return a[0]});a=b.indexOf(a);c=b.indexOf(c);return a-c},_bindEvents:function(){var b=this.eventNamespace,c=this;if(this.addRow!==
g)this.addRow.on("change"+b,".rm-item-select",function(){c._optionSelected()}).on("change"+b,".rm-realm-select",function(){c._realmSelected()}).on("click"+b,".rm-cancel-add",function(){c._resetAddRow()}).on("click"+b,".rm-submit-add",function(){c._addAssignment()});a(this.element).on("click"+b,".rm-delete-assignment",function(){c._deleteAssignment(a(this).closest(".rm-assignment"))});return!0},_unbindEvents:function(){var b=a(this.element),c=this.eventNamespace;this.addRow!==g&&this.addRow.off(c);
b.off(c);return!0}})})(jQuery);
