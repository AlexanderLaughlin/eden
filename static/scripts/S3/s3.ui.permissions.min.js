/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,m,g){b!=Array.prototype&&b!=Object.prototype&&(b[m]=g.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var b=0;return function(m){return $jscomp.SYMBOL_PREFIX+(m||"")+b++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.arrayIterator=function(b){var m=0;return $jscomp.iteratorPrototype(function(){return m<b.length?{done:!1,value:b[m++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,m){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var g=0,n={next:function(){if(g<b.length){var a=g++;return{value:m(a,b[a]),done:!1}}n.next=function(){return{done:!0,value:void 0}};return n.next()}};n[Symbol.iterator]=function(){return n};return n};
$jscomp.polyfill=function(b,m,g,n){if(m){g=$jscomp.global;b=b.split(".");for(n=0;n<b.length-1;n++){var a=b[n];a in g||(g[a]={});g=g[a]}b=b[b.length-1];n=g[b];m=m(n);m!=n&&null!=m&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:m})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
(function(b,m){var g={rm_Add:"Add",rm_AddRule:"Add Rule",rm_AllRecords:"All Records",rm_Cancel:"Cancel",rm_CollapseAll:"Collapse All",rm_ConfirmDeleteRule:"Do you want to delete this rule?",rm_DeleteRule:"Delete",rm_Default:"default",rm_ExpandAll:"Expand All",rm_NoAccess:"No access",rm_NoRestrictions:"No restrictions",rm_Others:"Others",rm_OwnedRecords:"Owned Records",rm_Page:"Page",rm_RestrictedTables:"Restricted Tables",rm_Scope:"Scope",rm_SystemTables:"System Tables",rm_Table:"Table",rm_UnrestrictedTables:"Unrestricted Tables",
rm_AssignedEntities:"Assigned Entities",rm_AllEntities:"All Entities"},n=0;b.widget("s3.permissionEdit",{options:{fRules:!1,tRules:!1,useRealms:!1,permissions:[{l:"CREATE",b:1,o:!1},{l:"READ",b:2,o:!0},{l:"UPDATE",b:4,o:!0},{l:"DELETE",b:8,o:!0}],modules:{},models:{},defaultPermissions:{},icons:{expanded:"fa fa-caret-down",collapsed:"fa fa-caret-right"}},_create:function(){this.id=n;n+=1;this.eventNamespace=".permissionEdit"},_init:function(){var a=b(this.element).attr("id");this.input=b("#"+a+"-input");
this.tableWidth=this.options.useRealms?5:4;for(var c in g)g[c]=i18n[c]||g[c];this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element),c=this.options;this._unbindEvents();this._deserialize();var d=this._ruleSets(),e=b(".rm-rules",a).first(),f=this,h=d.pages,k=b(".rm-page-rules",a);this._renderExpandCollapseAll().appendTo(k);Object.keys(c.modules).sort().forEach(function(a){c.modules[a][1]&&f._ruleTable("p",a,h[a]).appendTo(k)});h._other.length&&
this._ruleTable("p",null,h._other).appendTo(k);c.tRules&&(h=d.tables,k=b(".rm-table-rules",a),this._renderExpandCollapseAll().appendTo(k),Object.keys(c.models).sort().forEach(function(a){"_system"!=a&&f._ruleTable("t",a,h[a]).appendTo(k)}),this._ruleTable("t","_system",h._system).appendTo(k),h._other.length&&this._ruleTable("t",null,h._other).appendTo(k));e.tabs().removeClass("hide").show();this._bindEvents()},_deserialize:function(){try{this.rules=JSON.parse(this.input.val())}catch(a){this.rules=
[]}},_serialize:function(){var a=this.rules.filter(function(a){return null!==a[0]&&(0!==a[0]||!a[7])});this.input.val(JSON.stringify(a)).change()},_ruleSets:function(){var a={_other:[]},b={_other:[]},d=this.options;this.rules.forEach(function(c){var e;if(e=c[3]){var h=b;var k=d.models;e=e.split("_")[0]}else{h=a;k=d.modules;e=c[1];var g=c[2];e="default"!=e||"table"!=g&&"tables"!=g?e:"default/dt"}k.hasOwnProperty(e)?h[e]===m&&(h[e]=[]):e="_other";h[e].push(c)});return{pages:a,tables:b}},_renderExpandCollapseAll:function(){var a=
b('<span class="action-lnk rm-expand-all">'),c=b('<span class="action-lnk rm-collapse-all">');a.text(g.rm_ExpandAll);c.text(g.rm_CollapseAll);return b('<div class="rm-toggle-all">').append(a).append(c)},_ruleTable:function(a,c,d){d||(d=[]);var e=b('<table class="rm-module-rules">').data({module:c});e.append(this._ruleTableHeader(c)).append(this._ruleTableBody(a,c,d)).append(this._ruleTableFooter(a,c,d));this._indicateNumRules(e,d.length);return e},_ruleTableHeader:function(a){var c=b('<thead class="rm-module-header">'),
d=b("<th>").attr("colspan",this.tableWidth),e=this.options.icons;if(e){var f=b('<i class="'+e.expanded+'">').hide();e=b('<i class="'+e.collapsed+'">');b('<div class="rm-module-toggle">').append(f).append(e).appendTo(d)}switch(a){case "_system":f="SYSTEM";a=g.rm_SystemTables;break;case "_other":f="*";a=g.rm_Others;break;case "s3dt":f="S3DT";a=g.rm_DynamicTables;break;default:f="default/dt"==a?"DEFAULT":a.toLocaleUpperCase(),a=this.options.modules.hasOwnProperty(a)?this.options.modules[a][0]:""}b('<div class="rm-module-prefix">').text(f).appendTo(d);
b('<div class="rm-module-title">').text(a).appendTo(d);b('<div class="rm-module-numrules">').appendTo(d);b("<tr>").append(d).appendTo(c);return c},_ruleTableBody:function(a,c,d){var e=this.options,f=b("<tbody>").hide(),h=!0;if("t"==a){var k=d.map(function(a){return a[3]}),l=e.models[c];l&&Object.keys(l).forEach(function(a){l[a]&&-1==k.indexOf(a)&&d.push([null,null,null,a,null,null,null,!1])});a=g.rm_Table;0===d.length&&(h=!1,f.append(this._defaultRule(!1)))}else a=g.rm_Page,0===d.length&&(h=!1,f.append(this._defaultRule(!0)));
c=b('<tr class="rm-rule-labels">').hide().appendTo(f);c.append("<th>"+a+"</th>").append("<th>"+g.rm_AllRecords+"</th>").append("<th>"+g.rm_OwnedRecords+"</th>");e.useRealms&&b("<th>").text(g.rm_Scope).appendTo(c);c.append("<th></th>");if(h){c.show();d=d.sort(function(a,b){a=a.slice(1,4).join(" ");b=b.slice(1,4).join(" ");return a===b?0:a>b&&1||-1});var m=this;d.forEach(function(a){m._ruleTableRow(a).appendTo(f)})}return f},_ruleTableFooter:function(a,c,d){var e=b("<tfoot>").hide();if("_other"!=c){c=
b('<tr class="rm-module-add">');var f=b("<td>").attr("colspan",this.tableWidth);b('<span class="action-lnk rm-add-rule">').text(g.rm_AddRule).appendTo(f);"t"!=a&&!this.fRules&&d.length&&c.hide();c.append(f).appendTo(e)}return e},_ruleTableRow:function(a){var c=b('<tr class="rm-rule">').data({rule:a}),d=this.options,e=a[3],f;e?!0!==e&&(f=e):!0!==a[2]&&(f=a[1]+"/"+(a[2]||"*"));f?b('<td class="rm-rule-target">').text(f).appendTo(c):(e=this._targetSelector(a),b('<td class="rm-rule-target">').append(e).appendTo(c));
f&&null===a[0]?(c.addClass("rm-default-permissions"),a=this._defaultPermissions(f),a.oACL?(b("<td>").text(a.uACL).appendTo(c),b("<td>").text(a.oACL).appendTo(c)):b("<td>").attr("colspan",2).text(a.uACL).appendTo(c),d.useRealms&&b("<td>").appendTo(c),d=b('<a class="rm-add-rule action-lnk">'),b("<td>").append(d.text(g.rm_AddRule)).appendTo(c)):(e=this._permissionSelector(a),c.append(e.uACL).append(e.oACL),d.useRealms&&b("<td>").append(this._scopeSelector(a)).appendTo(c),f?(d=b('<a class="rm-delete-rule delete-btn-ajax">'),
b("<td>").append(d.text(g.rm_DeleteRule)).appendTo(c)):(d=b('<a class="rm-submit-rule action-btn">'),a=b('<span class="rm-cancel-add action-lnk">'),b("<td>").append(d.text(g.rm_Add)).append(a.text(g.rm_Cancel)).appendTo(c)));return c},_targetSelector:function(a){var c=this.options,d=b("<div>"),e=a[1],f=function(a,c){c===m&&(c=a);return b('<option value="'+a+'">').text(c)},h=function(){return b('<option value="">').prop("selected",!0).prop("disabled",!0).hide()};if(a[3]){var k=c.models[e],l=b("<optgroup>").attr("label",
g.rm_RestrictedTables),n=b("<optgroup>").attr("label",g.rm_UnrestrictedTables),q=0,p=0;Object.keys(k).sort().forEach(function(a){k[a]?(q+=1,l.append(f(a))):(p+=1,n.append(f(a)))});a=b("<select>").append(h());q&&a.append(l);p&&a.append(n)}else"_other"==e?(a=b('<input type="text" size="20">'),a.data("pattern",/^(\w+)(\/(\*|[\w]+))?$/)):"default/dt"==e?(a=b("<select>"),a.append(h()).append(f("default/table")).append(f("default/tables"))):(d.append("<span>"+e+" / </span>"),a=b('<input type="text" size="10">'),
a.data("pattern",/^(\w+|\*)$/));a.addClass("rm-target-select").appendTo(d);return d},_validateTarget:function(a){var b=a.val(),d=a.data("pattern");d.lastIndex=0;if(b&&d&&!d.exec(b))return a.addClass("rm-invalid"),!1;a.removeClass("rm-invalid");return!0},_defaultPermissions:function(a){var b=this.options,d=b.defaultPermissions[a];a={};var e=" ("+g.rm_Default+")";if(d!==m){var f=d[0];d=d[1]&~f;var h=function(a){var c=[];b.permissions.forEach(function(b){a&b.b&&c.push(b.l)});return c.join(", ")};f&&
(a.uACL=h(f)+e);d&&(a.oACL=h(d)+e)}a.uACL||(a.uACL=g.rm_NoAccess+e);return a},_defaultRule:function(a){a=a?g.rm_NoAccess:g.rm_NoRestrictions;a=b("<td>").attr("colspan",this.tableWidth).text(a);return b('<tr class="rm-default-rule">').append(a)},_permissionSelector:function(a){var c=b('<td class="rm-permission-all">'),d=b('<td class="rm-permission-own">');this.options.permissions.forEach(function(e){var f=b('<input class="rm-permission" type="checkbox">'),h=b('<input class="rm-permission" type="checkbox">');
b("<label>").append(f).append(e.l).appendTo(c);b("<label>").append(h).append(e.l).css({visibility:e.o&&"visible"||"hidden"}).appendTo(d);var g=a[5]&e.b;h.prop("checked",g);h.data({bit:e.b,selected:g,implied:!1});g=a[4]&e.b;f.prop("checked",g);f.data({bit:e.b,selected:g,implied:!1});h.data("implied",g);g&&h.prop({checked:!0,disabled:!0});f.data("imply",h)});return{uACL:c,oACL:d}},_scopeSelector:function(a){var c=b('<select class="rm-scope-select">'),d=b('<option value="">').text(g.rm_AssignedEntities),
e=b('<option value="any">').text(g.rm_AllEntities);if(a)switch(a[6]){case "any":e.prop("selected",!0);break;default:d.prop("selected",!0),a[6]=null}c.append(d).append(e);return b("<div>").append(c)},_addRule:function(a){var c=this.options,d=a.closest(".rm-module-rules"),e=d.data("module"),f=c.models[e],g=this;b("tfoot .rm-rule",b(this.element)).each(function(){g._cancelAdd(b(this))});var k=a.closest(".rm-rule");if(k.length){var l=k.data("rule");if(a=l[3]){l=[0,null,null,a,0,0,null,!1];if(c=c.defaultPermissions[a])l[4]=
c[0],l[5]=c[1];this.rules.push(l);l=this._ruleTableRow(l);k.after(l).remove();f[a]+=1;this._serialize()}}else f=!0,a.closest(".rm-table-rules").length?l=[0,e,null,!0,0,0,null,!1]:c.fRules?l=[0,e,!0,null,0,0,null,!1]:b("tbody .rm-rule",d).length||(l=[0,e,null,null,0,0,null,!1],f=!1),l&&(l=this._ruleTableRow(l),f?a.closest(".rm-module-add").hide().after(l):(b("tbody",d).append(l),a.closest(".rm-module-add").hide())),b(".rm-default-rule",d).hide(),b(".rm-rule-labels",d).show()},_submitAdd:function(a){var c=
a.closest(".rm-module-rules"),d=a.data("rule"),e=null,f=null,g=null,k=b(".rm-target-select",a).val().replace(/\s/,"");if(d[3]){if(g=k,!g)return}else{e=d[1];f=k;var l="_other"==e;if("default/dt"==e||l){if(k=/^(\w+)(\/(\*|[\w]+))?$/.exec(k))e=k[1],f=k[3];else return;if(l)for(l=b(".rm-module-rules",a.closest(".rm-page-rules")),k=l.length;k--;){var n=b(l[k]);if(n.data("module")==e){c=n;break}}}if(!f||"*"==f)f=null;else if(!/^\w+$/.exec(f))return}d[1]=e&&e.toLowerCase();d[2]=f&&f.toLowerCase();d[3]=g&&
g.toLowerCase();var q,p,r;b("tbody .rm-rule",c).each(function(){var a=b(this),c=a.data("rule");if(!q){a:{var e=null===d[0]||null===c[0]?[1,2,3]:[1,2,3,6];for(var h=e.length,k;h--;)if(k=e[h],d[k]!==c[k]){e=!1;break a}e=!0}e?(p=c,r=q=a):r||(g?c[3]>g&&(r=a):c[2]&&(f&&c[2]>f||!f)&&(r=a))}});if(p&&null!==p[0])p.splice(1,d.length-1),p.push.apply(p,d.slice(1)),d=p;else if(this.rules.push(d),e=d[3])l=this.options.models[c.data("module")],l[e]=l[e]!==m?l[e]+1:1;this._serialize();e=this._ruleTableRow(d);r?
e.insertBefore(r):e.appendTo(b("tbody",c));q&&q.remove();this._indicateNumRules(c,b("tbody .rm-rule",c).length);a.siblings(".rm-module-add").show();a.remove()},_cancelAdd:function(a){var c=a.closest(".rm-module-rules");0===b("tbody .rm-rule",c).length&&(b(".rm-rule-labels",c).hide(),b(".rm-default-rule",c).show());a.siblings(".rm-module-add").show();a.remove()},_updateRule:function(a,b){if(a=a.data("rule")){for(var c in b){var e=b[c];if(e!==m)switch(c){case "c":a[1]=e;break;case "f":a[2]=e;break;
case "t":a[3]=e;break;case "uACL":a[4]=e;break;case "oACL":a[5]=e;break;case "scope":a[6]=e;break;case "deleted":a[7]=!!e}}this._serialize()}},_deleteRule:function(a){if(confirm(g.rm_ConfirmDeleteRule)){var c=this.options,d=a.closest(".rm-module-rules"),e=!1,f=a.data("rule");f[7]=!0;this._serialize();var h=f[3];h?this.rules.filter(function(a){return a[3]==h&&!a[7]}).length||(f=d.data("module"),c=c.models[f],--c[h],0<c[h]&&this._ruleTableRow([null,null,null,h,null,null,null,!1]).insertBefore(a)):e=
!0;c=b(".rm-rule",d).length-1;c||(this._defaultRule(e).insertBefore(a),b(".rm-rule-labels",d).hide(),b(".rm-module-add",d).show());this._indicateNumRules(d,c);a.remove()}},_updatePermissions:function(a){this._updateRule(a,{uACL:this._getPermissions(b(".rm-permission-all",a)),oACL:this._getPermissions(b(".rm-permission-own",a))})},_getPermissions:function(a){var c=0;b(".rm-permission",a).each(function(){var a=b(this);!a.data("implied")&&a.data("selected")&&(a=a.data("bit"))&&(c|=a)});return c},_indicateNumRules:function(a,
c){var d=b(".rm-module-numrules",a);c?(d.text("["+c+"]"),a.addClass("hasrules")):(d.empty(),a.removeClass("hasrules"))},_toggleRuleTable:function(a){a.hasClass("rm-expanded")?(b("tbody, tfoot",a).hide(),a.removeClass("rm-expanded")):(b("tbody, tfoot",a).show(),a.addClass("rm-expanded"));b(".rm-module-toggle i",a).toggle()},_toggleAll:function(a,c){var d=this;c?b(".rm-module-rules:not(.rm-expanded)",a).each(function(a,c){d._toggleRuleTable(b(c))}):b(".rm-module-rules.rm-expanded",a).each(function(a,
c){d._toggleRuleTable(b(c))})},_permissionChanged:function(a){if(a.data("implied"))a.prop({checked:!0,disabled:!0});else if(a.prop("disabled"))a.prop({disabled:!1,checked:a.data("selected")});else{var b=a.prop("checked"),d=a.data("imply");a.data({selected:b});d&&d.length&&d.data("implied",b).change()}this._updatePermissions(a.closest(".rm-rule"))},_scopeChanged:function(a){var b=a.closest(".rm-rule").data("rule");switch(a.val()){case "any":b[6]="any";break;default:b[6]=null}this._serialize()},_bindEvents:function(){var a=
b(this.element),c=this.eventNamespace,d=this;b(".rm-table-rules, .rm-page-rules",a).on("click"+c,".rm-expand-all",function(){d._toggleAll(b(this).closest(".rm-table-rules, .rm-page-rules"),!0);return!1}).on("click"+c,".rm-collapse-all",function(){d._toggleAll(b(this).closest(".rm-table-rules, .rm-page-rules"),!1);return!1});b(".rm-module-rules",a).on("click"+c,".rm-module-header",function(){d._toggleRuleTable(b(this).closest(".rm-module-rules"));return!1}).on("change"+c,".rm-permission",function(){d._permissionChanged(b(this));
return!1}).on("change"+c,".rm-scope-select",function(){d._scopeChanged(b(this));return!1}).on("click"+c,".rm-delete-rule",function(){d._deleteRule(b(this).closest(".rm-rule"));return!1}).on("click"+c,".rm-add-rule",function(){d._addRule(b(this))}).on("click"+c,".rm-cancel-add",function(){d._cancelAdd(b(this).closest(".rm-rule"))}).on("click"+c,".rm-submit-rule",function(){d._submitAdd(b(this).closest(".rm-rule"))}).on("input"+c,"input.rm-target-select",function(){d._validateTarget(b(this))});return!0},
_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace;b(".rm-module-rules, .rm-table-rules, .rm-page-rules",a).off(c);return!0}})})(jQuery);
