/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(e,p){function l(){this.slices=[]}var n=0;l.prototype.store=function(a,c,b){var d={};b.forEach(function(a){d[a.id]=a});b=this.slices;a=[moment(a),moment(c),d];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var g=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(g.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),e.extend({},a[2],b[2])]});g.push(a);this.slices=
g}};l.prototype.retrieve=function(a,c){a=moment(a);c=moment(c);for(var b=this.slices,d=b.length,g,h,e=[],f=0;f<d;f++)if(g=b[f],g[0].isSameOrBefore(a)&&g[1].isSameOrAfter(c)){b=g[2];for(h in b)if(d=b[h],g=moment(d.start),!g.isAfter(c)){if(d.end){if(moment(d.end).isBefore(a))continue}else if(g.isSameOrBefore(moment(a).subtract(1,"days")))continue;e.push(d)}return e}return null};l.prototype.clear=function(){this.slices=[]};e.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null},_create:function(){this.id=
n;n+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){e.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options;this._unbindEvents();if(a.useTime){var c="month,agendaWeek reloadButton";var b="agendaWeek"}else c="month,basicWeek reloadButton",b="month";var d=this;e(this.element).fullCalendar({customButtons:{reloadButton:{text:"",click:function(){d.reload()}}},header:{left:c,center:"title",right:"today prev,next"},
eventRender:function(a,b){d._eventRender(a,b)},eventDestroy:function(a,b){d._eventDestroy(a,b)},defaultView:b,aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",selectable:!0,editable:!0,locale:a.locale,timezone:"local"});this.reloadButton=e(".fc-reloadButton-button").html('<i class="fa fa-refresh">');c=e('<div class="inline-throbber">').css({visibility:"hidden"});e(".fc-header-toolbar .fc-left",this.element).append(c);this.throbber=c;a=a.resources;this.resources=[];a&&
a.forEach(function(a,b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,c){var b=e.extend({},a,{_cache:new l});this.resources.push(b);a=b.timeout;a===p&&(a=this.options.timeout);var d=this;e(this.element).fullCalendar("addEventSource",{id:""+c,allDayDefault:!b.useTime,events:function(a,c,e,f){d._fetchItems(b,a,c,e,f)}})},_eventRender:function(a,c){var b=this;e(c).qtip({content:{title:function(c,e){return b._itemTitle(a,e)},text:function(c,e){return b._itemDisplay(a,e)},button:!0},
position:{at:"center right",my:"left center",effect:!1,viewport:e(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0}})},_eventDestroy:function(a,c){e(c).qtip("destroy",!0)},_itemTitle:function(a){var c=a.allDay&&"L"||"L LT",b=[a.start.format(c)];a.end&&b.push(a.end.format(c));return b.join(" - ")},_itemDisplay:function(a){var c=e('<div class="s3-organizer-popup">'),b=this.options.resources[a.source.id];e("<h6>").text(a.title).appendTo(c);
b=b.columns;var d=a.description;b&&d&&b.forEach(function(a){var b=a[0];a=a[1];d[b]!==p&&(a&&e("<label>").text(a).appendTo(c),e("<p>").html(d[b]).appendTo(c))});return c},_fetchItems:function(a,c,b,d,g){if(d=a._cache.retrieve(c,b))g(d);else{d=this.options;this._showThrobber();var h;a.filterForm?h=e("#"+a.filterForm):d.filterForm&&(h=e("#"+d.filterForm));h=S3.search.getCurrentFilters(h);var k,f=[];a.start&&(k=[a.start+"__ge",c.toISOString()]);var m=a.end?[a.end+"__lt",b.toISOString()]:[a.start+"__lt",
b.toISOString()];h.forEach(function(b){var c=b[0].split("__")[0];c===a.start?k&&(f.push(k),k=null,a.end||(f.push(m),m=null)):c===a.end?m&&(f.push(m),m=null):f.push(b)});k&&f.push(k);m&&f.push(m);if(h=a.ajaxURL){h=S3.search.filterURL(h,f);var l=a.timeout,n=e.ajaxS3;l===p&&(l=d.timeout);e.searchS3!==p&&(n=e.searchS3);if(d=a.openRequest)d.onreadystatechange=null,d.abort();var q=this;a.openRequest=n({timeout:l,url:h,dataType:"json",type:"GET",success:function(d){d=q._decodeServerData(d);q._hideThrobber();
a._cache.store(c,b,d);g(d)},error:function(a,b,c){q._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a){var c=a.columns;a=a.items;var b=0;c&&c.constructor===Array&&(b=c.length);a.forEach(function(a){var d={},e=a.description;if(b&&e&&e.constructor===Array){var k=e.length;if(k<=b)for(var f=0;f<k;f++)d[c[f]]=e[f]}a.description=d});return a},reload:function(){this.resources.forEach(function(a){a._cache.clear()});e(this.element).fullCalendar("refetchEvents")},
_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
