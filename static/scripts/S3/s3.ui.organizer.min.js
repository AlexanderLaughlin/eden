/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(d,q){function r(){this.slices=[]}var t=0;r.prototype.store=function(a,f,b){var c={};b.forEach(function(a){c[a.id]=a});b=this.slices;a=[moment(a),moment(f),c];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var e=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(e.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),d.extend({},a[2],b[2])]});e.push(a);this.slices=
e}};r.prototype.retrieve=function(a,f){a=moment(a);f=moment(f);for(var b=this.slices,c=b.length,e,g,d=[],h=0;h<c;h++)if(e=b[h],e[0].isSameOrBefore(a)&&e[1].isSameOrAfter(f)){b=e[2];for(g in b)if(c=b[g],e=moment(c.start),!e.isAfter(f)){if(c.end){if(moment(c.end).isBefore(a))continue}else if(e.isSameOrBefore(moment(a).subtract(1,"days")))continue;d.push(c)}return d}return null};r.prototype.clear=function(){this.slices=[]};d.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null},_create:function(){this.id=
t;t+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,f=a.resources;this._unbindEvents();for(var b=!1,c=f.length;c--;)if(f[c].insertable){b=!0;break}if(a.useTime){c="month,agendaWeek reloadButton";var e="agendaWeek"}else c="month,basicWeek reloadButton",e="month";var g=this;d(this.element).fullCalendar({aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",
snapDuration:"00:15:00",selectable:b,editable:!0,customButtons:{reloadButton:{text:"",click:function(){g.reload()}}},header:{left:c,center:"title",right:"today prev,next"},defaultView:e,eventRender:function(a,b){g._eventRender(a,b)},eventDestroy:function(a,b){g._eventDestroy(a,b)},select:function(a,b,c){g._selectDate(a,b,c)},unselect:function(){d(g.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});this.reloadButton=d(".fc-reloadButton-button").html('<i class="fa fa-refresh">');
a=d('<div class="inline-throbber">').css({visibility:"hidden"});d(".fc-header-toolbar .fc-left",this.element).append(a);this.throbber=a;this.resources=[];f&&f.forEach(function(a,b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,f){var b=d.extend({},a,{_cache:new r});this.resources.push(b);a=b.timeout;a===q&&(a=this.options.timeout);var c=this;d(this.element).fullCalendar("addEventSource",{id:""+f,allDayDefault:!b.useTime,editable:!!b.editable,durationEditable:!!b.end,events:function(a,
d,f,h){c._fetchItems(b,a,d,f,h)}})},_eventRender:function(a,f){var b=this;d(f).qtip({content:{title:function(c,e){return b._itemTitle(a,e)},text:function(c,e){return b._itemDisplay(a,e)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:d(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})},_eventDestroy:function(a,f){d(f).qtip("destroy",!0)},_itemTitle:function(a){var d=
a.allDay&&"L"||"L LT",b=[a.start.format(d)];a.end&&b.push(a.end.format(d));return b.join(" - ")},_itemDisplay:function(a,f){var b=d('<div class="s3-organizer-popup">'),c=this.options.resources[a.source.id];d("<h6>").text(a.title).appendTo(b);var e=c.columns,g=a.description;e&&g&&e.forEach(function(a){var c=a[0];a=a[1];g[c]!==q&&(a&&d("<label>").text(a).appendTo(b),d("<p>").html(g[c]).appendTo(b))});var l=d(this.element).attr("id"),h=this.eventNamespace;e=[];var k=c.baseURL;k&&(c.editable&&!1!==a.editable&&
(l=k+"/"+a.id+"/update.popup?refresh="+l,h=d('<a class="action-btn s3_modal">').text("Edit").attr("href",l).on("click"+h,function(){f.hide()}),e.push(h)),c.deletable&&!1!==a.deletable&&(h=d('<a class="action-btn delete-btn-ajax">').text("Delete"),e.push(h)));if(e.length){var m=d("<div>").appendTo(b);e.forEach(function(a){a.appendTo(m)})}return b},_selectDate:function(a,f,b){var c=this;d(this.element).qtip({content:{text:function(b,d){return c._selectResource(a,f,b,d)}},position:{target:"mouse",at:"center right",
my:"left center",effect:!1,viewport:d(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});d(this.element).qtip("show",b)},_selectResource:function(a,f,b,c){c.set("style.classes","s3-organizer-create");b=this.options.resources;var e=this.eventNamespace,g=d(this.element).attr("id"),l=d("<div>");b.forEach(function(b){if(b.insertable){var h=d('<a class="action-btn s3_modal">'),m=b.labelCreate;
if((b=b.baseURL)&&m){b+="/create.popup";var n=[];g&&n.push("refresh="+encodeURIComponent(g));var p=a.toISOString()+"--"+moment(f).subtract(1,"seconds").toISOString();n.push("organizer="+encodeURIComponent(p));b+="?"+n.join("&");h.attr("href",b).text(m).appendTo(l).on("click"+e,function(){c.hide()})}}});return l},_fetchItems:function(a,f,b,c,e){if(c=a._cache.retrieve(f,b))e(c);else{c=this.options;this._showThrobber();var g;a.filterForm?g=d("#"+a.filterForm):c.filterForm&&(g=d("#"+c.filterForm));g=
S3.search.getCurrentFilters(g);var l,h=[];a.start&&(l=[a.start+"__ge",f.toISOString()]);var k=a.end?[a.end+"__lt",b.toISOString()]:[a.start+"__lt",b.toISOString()];g.forEach(function(b){var c=b[0].split("__")[0];c===a.start?l&&(h.push(l),l=null,a.end||(h.push(k),k=null)):c===a.end?k&&(h.push(k),k=null):h.push(b)});l&&h.push(l);k&&h.push(k);if(g=a.ajaxURL){g=S3.search.filterURL(g,h);var m=a.timeout,n=d.ajaxS3;m===q&&(m=c.timeout);d.searchS3!==q&&(n=d.searchS3);if(c=a.openRequest)c.onreadystatechange=
null,c.abort();var p=this;a.openRequest=n({timeout:m,url:g,dataType:"json",type:"GET",success:function(c){c=p._decodeServerData(c);p._hideThrobber();a._cache.store(f,b,c);e(c)},error:function(a,b,c){p._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a){var d=a.c;a=a.r;var b=[],c=0;d&&d.constructor===Array&&(c=d.length);a.forEach(function(a){var g={},e=a.d;if(c&&e&&e.constructor===Array){var f=e.length;if(f<=c)for(var k=0;k<f;k++)g[d[k]]=
e[k]}g={id:a.id,title:a.t,start:a.s,end:a.e,description:g};a.pe||(g.editable=!1);a.pd||(g.deletable=!1);b.push(g)});return b},reload:function(){this.resources.forEach(function(a){a._cache.clear()});d(this.element).fullCalendar("refetchEvents")},_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
