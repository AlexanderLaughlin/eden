/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(e,p){function l(){this.slices=[]}var n=0;l.prototype.store=function(a,d,c){var b={};c.forEach(function(a){b[a.id]=a});c=this.slices;a=[moment(a),moment(d),b];c.push(a);c.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<c.length){var f=[];a=c.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(f.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),e.extend({},a[2],b[2])]});f.push(a);this.slices=
f}};l.prototype.retrieve=function(a,d){a=moment(a);d=moment(d);for(var c=this.slices,b=c.length,f,e,h=[],k=0;k<b;k++)if(f=c[k],f[0].isSameOrBefore(a)&&f[1].isSameOrAfter(d)){c=f[2];for(e in c)if(b=c[e],f=moment(b.start),!f.isAfter(d)){if(b.end){if(moment(b.end).isBefore(a))continue}else if(f.isSameOrBefore(moment(a).subtract(1,"days")))continue;h.push(b)}return h}return null};l.prototype.clear=function(){this.slices=[]};e.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null},_create:function(){this.id=
n;n+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){e.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options;this._unbindEvents();if(a.useTime){var d="month,agendaWeek reloadButton";var c="agendaWeek"}else d="month,basicWeek reloadButton",c="month";var b=this;e(this.element).fullCalendar({customButtons:{reloadButton:{text:"",click:function(){b.reload()}}},header:{left:d,center:"title",right:"today prev,next"},
locale:a.locale,defaultView:c,aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",selectable:!1,editable:!1,timezone:"local"});this.reloadButton=e(".fc-reloadButton-button").html('<i class="fa fa-refresh">');d=e('<div class="inline-throbber">').css({visibility:"hidden"});e(".fc-header-toolbar .fc-left",this.element).append(d);this.throbber=d;a=a.resources;this.resources=[];a&&a.forEach(function(a){this._addResource(a)},this);this._bindEvents()},_addResource:function(a){var d=
e.extend({},a,{_cache:new l});this.resources.push(d);a=d.timeout;a===p&&(a=this.options.timeout);var c=this;e(this.element).fullCalendar("addEventSource",{allDayDefault:!d.useTime,events:function(a,e,g,h){c._fetchItems(d,a,e,g,h)}})},_fetchItems:function(a,d,c,b,f){if(b=a._cache.retrieve(d,c))f(b);else{b=this.options;this._showThrobber();var g;a.filterForm?g=e("#"+a.filterForm):b.filterForm&&(g=e("#"+b.filterForm));g=S3.search.getCurrentFilters(g);var h,k=[];a.start&&(h=[a.start+"__ge",d.toISOString()]);
var m=a.end?[a.end+"__lt",c.toISOString()]:[a.start+"__lt",c.toISOString()];g.forEach(function(b){var c=b[0].split("__")[0];c===a.start?h&&(k.push(h),h=null,a.end||(k.push(m),m=null)):c===a.end?m&&(k.push(m),m=null):k.push(b)});h&&k.push(h);m&&k.push(m);if(g=a.ajaxURL){g=S3.search.filterURL(g,k);var l=a.timeout,n=e.ajaxS3;l===p&&(l=b.timeout);e.searchS3!==p&&(n=e.searchS3);if(b=a.openRequest)b.onreadystatechange=null,b.abort();var q=this;a.openRequest=n({timeout:l,url:g,dataType:"json",type:"GET",
success:function(b){q._hideThrobber();a._cache.store(d,c,b);f(b)},error:function(a,b,c){q._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},reload:function(){this.resources.forEach(function(a){a._cache.clear()});e(this.element).fullCalendar("refetchEvents")},_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",
!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
