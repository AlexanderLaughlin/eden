/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(e,n){function k(){this.items={};this.slices=[]}var p=0;k.prototype.store=function(a,d,b){var c={};b.forEach(function(a){this.items[a.id]=c[a.id]=a},this);b=this.slices;a=[moment(a),moment(d),c];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var g=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(g.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),e.extend({},
a[2],b[2])]});g.push(a);this.slices=g}};k.prototype.retrieve=function(a,d){a=moment(a);d=moment(d);for(var b=this.slices,c=b.length,g,f,e=[],l=0;l<c;l++)if(g=b[l],g[0].isSameOrBefore(a)&&g[1].isSameOrAfter(d)){b=g[2];for(f in b)if(c=b[f],g=moment(c.start),!g.isAfter(d)){if(c.end){if(moment(c.end).isBefore(a))continue}else if(g.isSameOrBefore(moment(a).subtract(1,"days")))continue;e.push(c)}return e}return null};k.prototype.updateItem=function(a,d){(a=this.items[a])&&d&&e.extend(a,d)};k.prototype.clear=
function(){this.slices=[]};e.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null},_create:function(){this.id=p;p+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){e.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,d=a.resources;this._unbindEvents();var b=!1,c=!1;d.forEach(function(a){a.insertable&&(b=!0);a.useTime||(c=!0)});if(a.useTime){var g="month,agendaWeek,agendaDay reloadButton";
var f="agendaWeek"}else g="month,basicWeek reloadButton",f="month";var h=this;e(this.element).fullCalendar({aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",defaultTimedEventDuration:"00:30:00",allDaySlot:c,selectable:b,editable:!0,eventDrop:function(a,b,c){h._updateItem(a,c)},eventResize:function(a,b,c){h._updateItem(a,c)},customButtons:{reloadButton:{text:"",click:function(){h.reload()}}},header:{left:g,center:"title",right:"today prev,next"},defaultView:f,eventRender:function(a,
b){h._eventRender(a,b)},eventDestroy:function(a,b){h._eventDestroy(a,b)},select:function(a,b,c){h._selectDate(a,b,c)},unselect:function(){e(h.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});this.reloadButton=e(".fc-reloadButton-button").html('<i class="fa fa-refresh">');a=e('<div class="inline-throbber">').css({visibility:"hidden"});e(".fc-header-toolbar .fc-left",this.element).append(a);this.throbber=a;this.resources=[];d&&d.forEach(function(a,
b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,d){var b=e.extend({},a,{_cache:new k});this.resources.push(b);a=b.timeout;a===n&&(a=this.options.timeout);var c=this;e(this.element).fullCalendar("addEventSource",{id:""+d,allDayDefault:!b.useTime,editable:!!b.editable,startEditable:!!b.startEditable,durationEditable:!!b.end&&!!b.durationEditable,events:function(a,d,e,l){c._fetchItems(b,a,d,e,l)}})},_eventRender:function(a,d){var b=this;e(d).qtip({content:{title:function(c,
d){return b._itemTitle(a,d)},text:function(c,d){return b._itemDisplay(a,d)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:e(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})},_eventDestroy:function(a,d){e(d).qtip("destroy",!0)},_itemTitle:function(a){var d=a.allDay&&"L"||"L LT",b=[a.start.format(d)];a.end&&b.push(a.end.format(d));return b.join(" - ")},_itemDisplay:function(a,
d){var b=e('<div class="s3-organizer-popup">'),c=this.options.resources[a.source.id];e("<h6>").text(a.title).appendTo(b);var g=c.columns,f=a.description;g&&f&&g.forEach(function(a){var c=a[0];a=a[1];f[c]!==n&&(a&&e("<label>").text(a).appendTo(b),e("<p>").html(f[c]).appendTo(b))});var h=e(this.element).attr("id"),l=this.eventNamespace;g=[];var q=c.baseURL;q&&(c.editable&&!1!==a.editable&&(h=q+"/"+a.id+"/update.popup?refresh="+h,l=e('<a class="action-btn s3_modal">').text("Edit").attr("href",h).on("click"+
l,function(){d.hide()}),g.push(l)),c.deletable&&!1!==a.deletable&&(l=e('<a class="action-btn delete-btn-ajax">').text("Delete"),g.push(l)));if(g.length){var m=e("<div>").appendTo(b);g.forEach(function(a){a.appendTo(m)})}return b},_selectDate:function(a,d,b){var c=this;e(this.element).qtip({content:{text:function(b,e){return c._selectResource(a,d,b,e)}},position:{target:"mouse",at:"center right",my:"left center",effect:!1,viewport:e(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",
solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});e(this.element).qtip("show",b)},_selectResource:function(a,d,b,c){c.set("style.classes","s3-organizer-create");b=this.options.resources;var g=this.eventNamespace,f=e(this.element).attr("id"),h=e("<div>");b.forEach(function(b){if(b.insertable){var l=e('<a class="action-btn s3_modal">'),m=b.labelCreate;if((b=b.baseURL)&&m){b+="/create.popup";var k=[];f&&k.push("refresh="+encodeURIComponent(f));var n=
a.toISOString()+"--"+moment(d).subtract(1,"seconds").toISOString();k.push("organizer="+encodeURIComponent(n));b+="?"+k.join("&");l.attr("href",b).text(m).appendTo(h).on("click"+g,function(){c.hide()})}}});return h},_fetchItems:function(a,d,b,c,g){if(c=a._cache.retrieve(d,b))g(c);else{c=this.options;this._showThrobber();var f;a.filterForm?f=e("#"+a.filterForm):c.filterForm&&(f=e("#"+c.filterForm));var h=S3.search.getCurrentFilters(f).filter(function(b){b=b[0].split("__")[0];return b!==a.start&&b!==
a.end});f=[];a.start&&f.push(a.start);a.end&&f.push(a.end);f.length&&(f=f.join("|"),h.push([f+"__ge",d.toISOString()]),h.push([f+"__lt",b.toISOString()]));if(f=a.ajaxURL){f=S3.search.filterURL(f,h);h=a.timeout;var l=e.ajaxS3;h===n&&(h=c.timeout);e.searchS3!==n&&(l=e.searchS3);if(c=a.openRequest)c.onreadystatechange=null,c.abort();var k=this;a.openRequest=l({timeout:h,url:f,dataType:"json",type:"GET",success:function(c){c=k._decodeServerData(a,c);k._hideThrobber();a._cache.store(d,b,c);g(c)},error:function(a,
b,c){k._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a,d){var b=d.c;d=d.r;var c=[],e=0;b&&b.constructor===Array&&(e=b.length);d.forEach(function(d){var g={},f=d.d;if(e&&f&&f.constructor===Array){var k=f.length;if(k<=e)for(var m=0;m<k;m++)g[b[m]]=f[m]}(f=d.e)&&(f=a.useTime?moment(f).add(1,"seconds").toISOString():moment(f).add(1,"days").startOf("day").toISOString());g={id:d.id,title:d.t,start:d.s,end:f,description:g};d.pe||(g.editable=
!1);d.pd||(g.deletable=!1);c.push(g)});return c},_updateItem:function(a,d){var b=this.resources[a.source.id],c=this,e={id:a.id,s:a.start.toISOString()};b.end&&(e.e=b.useTime?moment(a.end).subtract(1,"seconds").toISOString():moment(a.end).subtract(1,"days").endOf("day").toISOString());this._sendItems(b,{u:[e]},function(){b.reloadOnUpdate?c.reload():b._cache.updateItem(a.id,{start:a.start,end:a.end})},d)},_sendItems:function(a,d,b,c){var g=e('input[name="_formkey"]',this.element).val();d=JSON.stringify(e.extend({k:g},
d));this._showThrobber();var f=this;e.ajaxS3({type:"POST",url:a.ajaxURL,data:d,dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){"function"===typeof b&&b();f._hideThrobber()},error:function(){"function"===typeof c&&c();f._hideThrobber()}})},reload:function(){this.resources.forEach(function(a){a._cache.clear()});e(this.element).fullCalendar("refetchEvents")},_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},
_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
