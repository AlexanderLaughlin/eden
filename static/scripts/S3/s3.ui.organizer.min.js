/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires moment.js
 requires jQuery fullCalendar plugin
 requires qTip2
 requires jQuery UI datepicker
*/
(function(c,p){function n(){this.items={};this.slices=[]}var q=0;n.prototype.store=function(a,e,b){var g={};b.forEach(function(a){this.items[a.id]=g[a.id]=a},this);b=this.slices;a=[moment(a),moment(e),g];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var d=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(d.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),c.extend({},
a[2],b[2])]});d.push(a);this.slices=d}};n.prototype.retrieve=function(a,e){a=moment(a);e=moment(e);for(var b=this.slices,g=b.length,d,f,c=[],h=0;h<g;h++)if(d=b[h],d[0].isSameOrBefore(a)&&d[1].isSameOrAfter(e)){b=d[2];for(f in b)if(g=b[f],d=moment(g.start),!d.isAfter(e)){if(g.end){if(moment(g.end).isBefore(a))continue}else if(d.isSameOrBefore(moment(a).subtract(1,"days")))continue;c.push(g)}return c}return null};n.prototype.updateItem=function(a,e){(a=this.items[a])&&e&&c.extend(a,e)};n.prototype.clear=
function(){this.slices=[]};c.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null},_create:function(){this.id=q;q+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,e=a.resources,b=c(this.element),g=b.attr("id");this._unbindEvents();var d=!1,f=!1;e.forEach(function(a){a.insertable&&(d=!0);a.useTime||(f=!0)});if(a.useTime){var k=
"month,agendaWeek,agendaDay reload";var h="agendaWeek"}else k="month,basicWeek reload",h="month";var l=this,m=c("#"+g+"-date-picker");c(this.element).fullCalendar({aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",defaultTimedEventDuration:"00:30:00",allDaySlot:f,selectable:d,editable:!0,eventDrop:function(a,b,d){l._updateItem(a,d)},eventResize:function(a,b,d){l._updateItem(a,d)},customButtons:{reload:{text:"",click:function(){l.reload()}},calendar:{text:"",click:function(){m.datepicker("show")}}},
header:{left:k,center:"title",right:"calendar today prev,next"},defaultView:h,eventRender:function(a,b){l._eventRender(a,b)},eventDestroy:function(a,b){l._eventDestroy(a,b)},select:function(a,b,d){l._selectDate(a,b,d)},unselect:function(){c(l.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});this.reloadButton=c(".fc-reload-button").html('<i class="fa fa-refresh">');a=c(".fc-calendar-button").html('<i class="fa fa-calendar">');m.datepicker("option",
{showOn:"focus",showButtonPanel:!0}).insertBefore(a).on("change",function(){var a=m.datepicker("getDate");a&&b.fullCalendar("gotoDate",a)});a=c('<div class="inline-throbber">').css({visibility:"hidden"});c(".fc-header-toolbar .fc-left",this.element).append(a);this.throbber=a;this.resources=[];e&&e.forEach(function(a,b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,e){var b=c.extend({},a,{_cache:new n});this.resources.push(b);a=b.timeout;a===p&&(a=this.options.timeout);
var g=this;c(this.element).fullCalendar("addEventSource",{id:""+e,allDayDefault:!b.useTime,editable:!!b.editable,startEditable:!!b.startEditable,durationEditable:!!b.end&&!!b.durationEditable,events:function(a,c,e,h){g._fetchItems(b,a,c,e,h)}})},_eventRender:function(a,e){var b=this;c(e).qtip({content:{title:function(c,d){return b._itemTitle(a,d)},text:function(c,d){return b._itemDisplay(a,d)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:c(window),adjust:{method:"flip shift"}},
show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})},_eventDestroy:function(a,e){c(e).qtip("destroy",!0)},_itemTitle:function(a){var c=a.allDay&&"L"||"L LT",b=[a.start.format(c)];a.end&&b.push(a.end.format(c));return b.join(" - ")},_itemDisplay:function(a,e){var b=c('<div class="s3-organizer-popup">'),g=this.options.resources[a.source.id];c("<h6>").text(a.title).appendTo(b);var d=g.columns,f=a.description;d&&f&&d.forEach(function(a){var d=
a[0];a=a[1];f[d]!==p&&(a&&c("<label>").text(a).appendTo(b),c("<p>").html(f[d]).appendTo(b))});var k=c(this.element).attr("id"),h=this.eventNamespace;d=[];var l=g.baseURL;l&&(g.editable&&!1!==a.editable&&(k=l+"/"+a.id+"/update.popup?refresh="+k,h=c('<a class="action-btn s3_modal">').text("Edit").attr("href",k).on("click"+h,function(){e.hide()}),d.push(h)),g.deletable&&!1!==a.deletable&&(h=c('<a class="action-btn delete-btn-ajax">').text("Delete"),d.push(h)));if(d.length){var m=c("<div>").appendTo(b);
d.forEach(function(a){a.appendTo(m)})}return b},_selectDate:function(a,e,b){var g=this;c(this.element).qtip({content:{text:function(b,c){return g._selectResource(a,e,b,c)}},position:{target:"mouse",at:"center right",my:"left center",effect:!1,viewport:c(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});c(this.element).qtip("show",b)},_selectResource:function(a,e,b,g){g.set("style.classes",
"s3-organizer-create");b=this.options.resources;var d=this.eventNamespace,f=c(this.element).attr("id"),k=c("<div>");b.forEach(function(b){if(b.insertable){var h=c('<a class="action-btn s3_modal">'),m=b.labelCreate;if((b=b.baseURL)&&m){b+="/create.popup";var n=[];f&&n.push("refresh="+encodeURIComponent(f));var p=a.toISOString()+"--"+moment(e).subtract(1,"seconds").toISOString();n.push("organizer="+encodeURIComponent(p));b+="?"+n.join("&");h.attr("href",b).text(m).appendTo(k).on("click"+d,function(){g.hide()})}}});
return k},_fetchItems:function(a,e,b,g,d){if(g=a._cache.retrieve(e,b))d(g);else{g=this.options;this._showThrobber();var f;a.filterForm?f=c("#"+a.filterForm):g.filterForm&&(f=c("#"+g.filterForm));var k=S3.search.getCurrentFilters(f).filter(function(b){b=b[0].split("__")[0];return b!==a.start&&b!==a.end});f=[];a.start&&f.push(a.start);a.end&&f.push(a.end);f.length&&(f=f.join("|"),k.push([f+"__ge",e.toISOString()]),k.push([f+"__lt",b.toISOString()]));if(f=a.ajaxURL){f=S3.search.filterURL(f,k);k=a.timeout;
var h=c.ajaxS3;k===p&&(k=g.timeout);c.searchS3!==p&&(h=c.searchS3);if(g=a.openRequest)g.onreadystatechange=null,g.abort();var l=this;a.openRequest=h({timeout:k,url:f,dataType:"json",type:"GET",success:function(c){c=l._decodeServerData(a,c);l._hideThrobber();a._cache.store(e,b,c);d(c)},error:function(a,b,c){l._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a,c){var b=c.c;c=c.r;var g=[],d=0;b&&b.constructor===Array&&(d=b.length);
c.forEach(function(c){var e={},f=c.d;if(d&&f&&f.constructor===Array){var l=f.length;if(l<=d)for(var m=0;m<l;m++)e[b[m]]=f[m]}(f=c.e)&&(f=a.useTime?moment(f).add(1,"seconds").toISOString():moment(f).add(1,"days").startOf("day").toISOString());e={id:c.id,title:c.t,start:c.s,end:f,description:e};c.pe||(e.editable=!1);c.pd||(e.deletable=!1);g.push(e)});return g},_updateItem:function(a,c){var b=this.resources[a.source.id],e=this,d={id:a.id,s:a.start.toISOString()};b.end&&(d.e=b.useTime?moment(a.end).subtract(1,
"seconds").toISOString():moment(a.end).subtract(1,"days").endOf("day").toISOString());this._sendItems(b,{u:[d]},function(){b.reloadOnUpdate?e.reload():b._cache.updateItem(a.id,{start:a.start,end:a.end})},c)},_sendItems:function(a,e,b,g){var d=c('input[name="_formkey"]',this.element).val();e=JSON.stringify(c.extend({k:d},e));this._showThrobber();var f=this;c.ajaxS3({type:"POST",url:a.ajaxURL,data:e,dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){"function"===
typeof b&&b();f._hideThrobber()},error:function(){"function"===typeof g&&g();f._hideThrobber()}})},reload:function(){this.resources.forEach(function(a){a._cache.clear()});c(this.element).fullCalendar("refetchEvents")},_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
