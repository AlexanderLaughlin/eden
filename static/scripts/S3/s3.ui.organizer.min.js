/*
 2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(d,q){function m(){this.slices=[]}var p=0;m.prototype.store=function(a,c,b){var e={};b.forEach(function(a){e[a.id]=a});b=this.slices;a=[moment(a),moment(c),e];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var g=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(g.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),d.extend({},a[2],b[2])]});g.push(a);this.slices=
g}};m.prototype.retrieve=function(a,c){a=moment(a);c=moment(c);for(var b=this.slices,e=b.length,g,h,d=[],f=0;f<e;f++)if(g=b[f],g[0].isSameOrBefore(a)&&g[1].isSameOrAfter(c)){b=g[2];for(h in b)if(e=b[h],g=moment(e.start),!g.isAfter(c)){if(e.end){if(moment(e.end).isBefore(a))continue}else if(g.isSameOrBefore(moment(a).subtract(1,"days")))continue;d.push(e)}return d}return null};m.prototype.clear=function(){this.slices=[]};d.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null},_create:function(){this.id=
p;p+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options;this._unbindEvents();if(a.useTime){var c="month,agendaWeek reloadButton";var b="agendaWeek"}else c="month,basicWeek reloadButton",b="month";var e=this;d(this.element).fullCalendar({aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",selectable:!0,editable:!0,customButtons:{reloadButton:{text:"",
click:function(){e.reload()}}},header:{left:c,center:"title",right:"today prev,next"},defaultView:b,eventRender:function(a,b){e._eventRender(a,b)},eventDestroy:function(a,b){e._eventDestroy(a,b)},select:function(a,b,c){e._selectDate(a,b,c)},unselect:function(){d(e.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});this.reloadButton=d(".fc-reloadButton-button").html('<i class="fa fa-refresh">');c=d('<div class="inline-throbber">').css({visibility:"hidden"});
d(".fc-header-toolbar .fc-left",this.element).append(c);this.throbber=c;a=a.resources;this.resources=[];a&&a.forEach(function(a,b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,c){var b=d.extend({},a,{_cache:new m});this.resources.push(b);a=b.timeout;a===q&&(a=this.options.timeout);var e=this;d(this.element).fullCalendar("addEventSource",{id:""+c,allDayDefault:!b.useTime,events:function(a,c,d,f){e._fetchItems(b,a,c,d,f)}})},_eventRender:function(a,c){var b=this;d(c).qtip({content:{title:function(c,
d){return b._itemTitle(a,d)},text:function(c,d){return b._itemDisplay(a,d)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:d(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0}})},_eventDestroy:function(a,c){d(c).qtip("destroy",!0)},_itemTitle:function(a){var c=a.allDay&&"L"||"L LT",b=[a.start.format(c)];a.end&&b.push(a.end.format(c));return b.join(" - ")},_itemDisplay:function(a){var c=d('<div class="s3-organizer-popup">'),
b=this.options.resources[a.source.id];d("<h6>").text(a.title).appendTo(c);b=b.columns;var e=a.description;b&&e&&b.forEach(function(a){var b=a[0];a=a[1];e[b]!==q&&(a&&d("<label>").text(a).appendTo(c),d("<p>").html(e[b]).appendTo(c))});return c},_selectDate:function(a,c,b){var e=this;d(this.element).qtip({content:{text:function(b,d){return e._selectResource(a,c,b,d)}},position:{target:"mouse",at:"center right",my:"left center",effect:!1,viewport:d(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",
solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});d(this.element).qtip("show",b)},_selectResource:function(a,c,b,e){e.set("style.classes","s3-organizer-create");b=this.options.resources;var g=d(this.element),h=this.eventNamespace,k=g.attr("id"),f=d("<div>");b.forEach(function(b){if(b.insertable){var e=d('<a class="action-btn s3_modal">'),l=b.labelCreate;if((b=b.baseURL)&&l){b+="/create.popup";var n=[];k&&n.push("refresh="+encodeURIComponent(k));var r=
a.toISOString()+"--"+moment(c).subtract(1,"seconds").toISOString();n.push("organizer="+encodeURIComponent(r));b+="?"+n.join("&");e.attr("href",b).text(l).appendTo(f).off(h).on("click"+h,function(){g.qtip("hide")})}}});return f},_fetchItems:function(a,c,b,e,g){if(e=a._cache.retrieve(c,b))g(e);else{e=this.options;this._showThrobber();var h;a.filterForm?h=d("#"+a.filterForm):e.filterForm&&(h=d("#"+e.filterForm));h=S3.search.getCurrentFilters(h);var k,f=[];a.start&&(k=[a.start+"__ge",c.toISOString()]);
var l=a.end?[a.end+"__lt",b.toISOString()]:[a.start+"__lt",b.toISOString()];h.forEach(function(b){var c=b[0].split("__")[0];c===a.start?k&&(f.push(k),k=null,a.end||(f.push(l),l=null)):c===a.end?l&&(f.push(l),l=null):f.push(b)});k&&f.push(k);l&&f.push(l);if(h=a.ajaxURL){h=S3.search.filterURL(h,f);var m=a.timeout,p=d.ajaxS3;m===q&&(m=e.timeout);d.searchS3!==q&&(p=d.searchS3);if(e=a.openRequest)e.onreadystatechange=null,e.abort();var n=this;a.openRequest=p({timeout:m,url:h,dataType:"json",type:"GET",
success:function(d){d=n._decodeServerData(d);n._hideThrobber();a._cache.store(c,b,d);g(d)},error:function(a,b,c){n._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a){var c=a.columns;a=a.items;var b=0;c&&c.constructor===Array&&(b=c.length);a.forEach(function(a){var d={},e=a.description;if(b&&e&&e.constructor===Array){var k=e.length;if(k<=b)for(var f=0;f<k;f++)d[c[f]]=e[f]}a.description=d});return a},reload:function(){this.resources.forEach(function(a){a._cache.clear()});
d(this.element).fullCalendar("refetchEvents")},_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
